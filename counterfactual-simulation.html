<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>4 Counterfactual Simulation | Monte Carlo Simulation: Jin and Vasserman (2021)</title>
  <meta name="description" content="4 Counterfactual Simulation | Monte Carlo Simulation: Jin and Vasserman (2021)" />
  <meta name="generator" content="bookdown 0.31 and GitBook 2.6.7" />

  <meta property="og:title" content="4 Counterfactual Simulation | Monte Carlo Simulation: Jin and Vasserman (2021)" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="4 Counterfactual Simulation | Monte Carlo Simulation: Jin and Vasserman (2021)" />
  
  
  

<meta name="author" content="Yuki KAYABA" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="estimation.html"/>

<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="generate-data-for-choice-model.html"><a href="generate-data-for-choice-model.html"><i class="fa fa-check"></i><b>1</b> Generate Data for Choice Model</a>
<ul>
<li class="chapter" data-level="1.1" data-path="generate-data-for-choice-model.html"><a href="generate-data-for-choice-model.html#generate-lambda"><i class="fa fa-check"></i><b>1.1</b> Generate <span class="math inline">\(\lambda\)</span></a></li>
<li class="chapter" data-level="1.2" data-path="generate-data-for-choice-model.html"><a href="generate-data-for-choice-model.html#generate-expectation-of-monitoring-score-and-out-of-pocket"><i class="fa fa-check"></i><b>1.2</b> Generate (Expectation of) Monitoring Score and Out-of-Pocket</a></li>
<li class="chapter" data-level="1.3" data-path="generate-data-for-choice-model.html"><a href="generate-data-for-choice-model.html#generate-choice-in-t-0"><i class="fa fa-check"></i><b>1.3</b> Generate Choice in <span class="math inline">\(t = 0\)</span></a></li>
<li class="chapter" data-level="1.4" data-path="generate-data-for-choice-model.html"><a href="generate-data-for-choice-model.html#generate-realization-of-cost-in-t-0"><i class="fa fa-check"></i><b>1.4</b> Generate Realization of Cost in <span class="math inline">\(t = 0\)</span></a></li>
<li class="chapter" data-level="1.5" data-path="generate-data-for-choice-model.html"><a href="generate-data-for-choice-model.html#generate-choice-in-t-1"><i class="fa fa-check"></i><b>1.5</b> Generate Choice in <span class="math inline">\(t = 1\)</span></a></li>
<li class="chapter" data-level="1.6" data-path="generate-data-for-choice-model.html"><a href="generate-data-for-choice-model.html#merge-choice-data"><i class="fa fa-check"></i><b>1.6</b> Merge Choice Data</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="generate-data-for-cost-model.html"><a href="generate-data-for-cost-model.html"><i class="fa fa-check"></i><b>2</b> Generate Data for Cost Model</a></li>
<li class="chapter" data-level="3" data-path="estimation.html"><a href="estimation.html"><i class="fa fa-check"></i><b>3</b> Estimation</a>
<ul>
<li class="chapter" data-level="3.1" data-path="estimation.html"><a href="estimation.html#fuctions"><i class="fa fa-check"></i><b>3.1</b> Fuctions</a></li>
<li class="chapter" data-level="3.2" data-path="estimation.html"><a href="estimation.html#optimization"><i class="fa fa-check"></i><b>3.2</b> Optimization</a></li>
<li class="chapter" data-level="3.3" data-path="estimation.html"><a href="estimation.html#estimation-results"><i class="fa fa-check"></i><b>3.3</b> Estimation Results</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="counterfactual-simulation.html"><a href="counterfactual-simulation.html"><i class="fa fa-check"></i><b>4</b> Counterfactual Simulation</a>
<ul>
<li class="chapter" data-level="4.1" data-path="counterfactual-simulation.html"><a href="counterfactual-simulation.html#welfare-calculation"><i class="fa fa-check"></i><b>4.1</b> Welfare Calculation</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Monte Carlo Simulation: Jin and Vasserman (2021)</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="counterfactual-simulation" class="section level1 hasAnchor" number="4">
<h1><span class="header-section-number">4</span> Counterfactual Simulation<a href="counterfactual-simulation.html#counterfactual-simulation" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="welfare-calculation" class="section level2 hasAnchor" number="4.1">
<h2><span class="header-section-number">4.1</span> Welfare Calculation<a href="counterfactual-simulation.html#welfare-calculation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Using our demand estimates, we evaluate the impact that the monitoring program has on consumer welfare and on firm profits in the status quo. To do this, we simulate a counterfactual scenario in which monitoring is not available, and compare it to the status quo baseline with monitoring.</p>
<ol style="list-style-type: decimal">
<li>For each driver <span class="math inline">\(i\)</span>, simulate random coefficients (private risk) <span class="math inline">\(L \in \mathbb{N}^{+}\)</span> times</li>
<li>For each draw <span class="math inline">\(l \in \{ 1, ..., L \}\)</span>, calculate ex-ante utility directly and the corresponding certainty equivalent. First-period choice probabilities are also calculated, which gives us the monitoring share. Expected cost of the first semester can be calculated directly. But we also need to form an expectation of the second-period cost (and prices) in order to calculate total surplus (and profit):</li>
<li>Simulate <span class="math inline">\(K \in \mathbb{N}^{+}\)</span> draws of first-period claim occurrence and monitoring score based on private risk . Each draw pins down the renewal price change that driver <span class="math inline">\(i\)</span> would face in the second period. All other prices remain constant. For each first-period choice <span class="math inline">\(d\)</span>, we can then calculate the second period choice probability and the corresponding expected cost</li>
</ol>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="counterfactual-simulation.html#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of Draws</span></span>
<span id="cb19-2"><a href="counterfactual-simulation.html#cb19-2" aria-hidden="true" tabindex="-1"></a>L <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb19-3"><a href="counterfactual-simulation.html#cb19-3" aria-hidden="true" tabindex="-1"></a>K <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb19-4"><a href="counterfactual-simulation.html#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="counterfactual-simulation.html#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="do">## df for t = 0</span></span>
<span id="cb19-6"><a href="counterfactual-simulation.html#cb19-6" aria-hidden="true" tabindex="-1"></a>df_t0 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb19-7"><a href="counterfactual-simulation.html#cb19-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(t <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb19-8"><a href="counterfactual-simulation.html#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="counterfactual-simulation.html#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="do">## Simulate Private Risk Lambda</span></span>
<span id="cb19-10"><a href="counterfactual-simulation.html#cb19-10" aria-hidden="true" tabindex="-1"></a>sim_lambda <span class="ot">&lt;-</span> <span class="fu">gen_lambda</span>(df_t0, cost_par, L)</span>
<span id="cb19-11"><a href="counterfactual-simulation.html#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="counterfactual-simulation.html#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="do">## Calculate Certainty Equivalent for Each Draw</span></span>
<span id="cb19-13"><a href="counterfactual-simulation.html#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="do">### theta_estを入れるのが正しいが挙動確認のためthetaを入れている</span></span>
<span id="cb19-14"><a href="counterfactual-simulation.html#cb19-14" aria-hidden="true" tabindex="-1"></a>cal_certainty_equivalent <span class="ot">&lt;-</span> <span class="cf">function</span>(df, theta, cost_par, R, lambda){</span>
<span id="cb19-15"><a href="counterfactual-simulation.html#cb19-15" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Risk Aversion</span></span>
<span id="cb19-16"><a href="counterfactual-simulation.html#cb19-16" aria-hidden="true" tabindex="-1"></a>  risk_aversion <span class="ot">&lt;-</span> theta[<span class="dv">15</span>]</span>
<span id="cb19-17"><a href="counterfactual-simulation.html#cb19-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-18"><a href="counterfactual-simulation.html#cb19-18" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Calculate CE</span></span>
<span id="cb19-19"><a href="counterfactual-simulation.html#cb19-19" aria-hidden="true" tabindex="-1"></a>  <span class="do">### We apply `cal_v` to obtain v</span></span>
<span id="cb19-20"><a href="counterfactual-simulation.html#cb19-20" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> <span class="fu">cal_v</span>(df, theta, cost_par, R, lambda) <span class="sc">%&gt;%</span> </span>
<span id="cb19-21"><a href="counterfactual-simulation.html#cb19-21" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">&quot;v&quot;</span>)),</span>
<span id="cb19-22"><a href="counterfactual-simulation.html#cb19-22" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">funs</span>(<span class="dv">1</span> <span class="sc">/</span> risk_aversion <span class="sc">-</span> <span class="fu">sqrt</span>((<span class="dv">1</span> <span class="sc">/</span> risk_aversion<span class="sc">^</span><span class="dv">2</span>) <span class="sc">-</span> <span class="dv">2</span><span class="sc">*</span>. <span class="sc">/</span> risk_aversion))) <span class="sc">%&gt;%</span> </span>
<span id="cb19-23"><a href="counterfactual-simulation.html#cb19-23" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;v&quot;</span>, <span class="st">&quot;certatinty_equivalent&quot;</span>), </span>
<span id="cb19-24"><a href="counterfactual-simulation.html#cb19-24" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;v&quot;</span>))</span>
<span id="cb19-25"><a href="counterfactual-simulation.html#cb19-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-26"><a href="counterfactual-simulation.html#cb19-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(output)</span>
<span id="cb19-27"><a href="counterfactual-simulation.html#cb19-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-28"><a href="counterfactual-simulation.html#cb19-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-29"><a href="counterfactual-simulation.html#cb19-29" aria-hidden="true" tabindex="-1"></a>sim_renewal_price <span class="ot">&lt;-</span> <span class="cf">function</span>(df, theta, cost_par, R, lambda){</span>
<span id="cb19-30"><a href="counterfactual-simulation.html#cb19-30" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Generate Claims</span></span>
<span id="cb19-31"><a href="counterfactual-simulation.html#cb19-31" aria-hidden="true" tabindex="-1"></a>  lambda_mat <span class="ot">&lt;-</span> lambda <span class="sc">%&gt;%</span> </span>
<span id="cb19-32"><a href="counterfactual-simulation.html#cb19-32" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb19-33"><a href="counterfactual-simulation.html#cb19-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.matrix</span>()</span>
<span id="cb19-34"><a href="counterfactual-simulation.html#cb19-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-35"><a href="counterfactual-simulation.html#cb19-35" aria-hidden="true" tabindex="-1"></a>  claims <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rpois</span>(<span class="fu">dim</span>(df)[<span class="dv">1</span>]<span class="sc">*</span>L<span class="sc">*</span>K, <span class="at">lambda =</span> lambda_mat), <span class="at">nrow =</span> <span class="fu">dim</span>(df)[<span class="dv">1</span>])</span>
<span id="cb19-36"><a href="counterfactual-simulation.html#cb19-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(claims) <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;claims&quot;</span>, <span class="dv">1</span><span class="sc">:</span>(L<span class="sc">*</span>K), <span class="at">sep =</span> <span class="st">&quot;_&quot;</span>)</span>
<span id="cb19-37"><a href="counterfactual-simulation.html#cb19-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-38"><a href="counterfactual-simulation.html#cb19-38" aria-hidden="true" tabindex="-1"></a>  claims <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(claims) <span class="sc">%&gt;%</span> </span>
<span id="cb19-39"><a href="counterfactual-simulation.html#cb19-39" aria-hidden="true" tabindex="-1"></a>    tibble<span class="sc">::</span><span class="fu">as_tibble</span>()  </span>
<span id="cb19-40"><a href="counterfactual-simulation.html#cb19-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-41"><a href="counterfactual-simulation.html#cb19-41" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Generate Monitoring Score</span></span>
<span id="cb19-42"><a href="counterfactual-simulation.html#cb19-42" aria-hidden="true" tabindex="-1"></a>  theta_score <span class="ot">&lt;-</span> cost_par[<span class="dv">8</span><span class="sc">:</span><span class="dv">11</span>]</span>
<span id="cb19-43"><a href="counterfactual-simulation.html#cb19-43" aria-hidden="true" tabindex="-1"></a>  sigma_score <span class="ot">&lt;-</span> cost_par[<span class="dv">12</span>]</span>
<span id="cb19-44"><a href="counterfactual-simulation.html#cb19-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-45"><a href="counterfactual-simulation.html#cb19-45" aria-hidden="true" tabindex="-1"></a>  mu_score <span class="ot">&lt;-</span> lambda <span class="sc">%&gt;%</span></span>
<span id="cb19-46"><a href="counterfactual-simulation.html#cb19-46" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)),</span>
<span id="cb19-47"><a href="counterfactual-simulation.html#cb19-47" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">funs</span>(theta_score[<span class="dv">1</span>] <span class="sc">+</span> theta_score[<span class="dv">2</span>]<span class="sc">*</span><span class="fu">log</span>(.)</span>
<span id="cb19-48"><a href="counterfactual-simulation.html#cb19-48" aria-hidden="true" tabindex="-1"></a>                          <span class="sc">+</span> theta_score[<span class="dv">3</span>]<span class="sc">*</span>x_1 <span class="sc">+</span> theta_score[<span class="dv">4</span>]<span class="sc">*</span>x_2)) <span class="sc">%&gt;%</span></span>
<span id="cb19-49"><a href="counterfactual-simulation.html#cb19-49" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;lambda&quot;</span>, <span class="st">&quot;mu_score&quot;</span>),</span>
<span id="cb19-50"><a href="counterfactual-simulation.html#cb19-50" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb19-51"><a href="counterfactual-simulation.html#cb19-51" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">&quot;mu_score&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb19-52"><a href="counterfactual-simulation.html#cb19-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.matrix</span>()</span>
<span id="cb19-53"><a href="counterfactual-simulation.html#cb19-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-54"><a href="counterfactual-simulation.html#cb19-54" aria-hidden="true" tabindex="-1"></a>  score <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rlnorm</span>(<span class="fu">dim</span>(df)[<span class="dv">1</span>]<span class="sc">*</span>L<span class="sc">*</span>K, mu_score, sigma_score), <span class="at">nrow =</span> <span class="fu">dim</span>(df)[<span class="dv">1</span>])</span>
<span id="cb19-55"><a href="counterfactual-simulation.html#cb19-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(score) <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;score&quot;</span>, <span class="dv">1</span><span class="sc">:</span>(L<span class="sc">*</span>K), <span class="at">sep =</span> <span class="st">&quot;_&quot;</span>)</span>
<span id="cb19-56"><a href="counterfactual-simulation.html#cb19-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-57"><a href="counterfactual-simulation.html#cb19-57" aria-hidden="true" tabindex="-1"></a>  score <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(score) <span class="sc">%&gt;%</span></span>
<span id="cb19-58"><a href="counterfactual-simulation.html#cb19-58" aria-hidden="true" tabindex="-1"></a>    tibble<span class="sc">::</span><span class="fu">as_tibble</span>()</span>
<span id="cb19-59"><a href="counterfactual-simulation.html#cb19-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-60"><a href="counterfactual-simulation.html#cb19-60" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Calculate Claim Surcharge R_C</span></span>
<span id="cb19-61"><a href="counterfactual-simulation.html#cb19-61" aria-hidden="true" tabindex="-1"></a>  R_C <span class="ot">&lt;-</span> claims <span class="sc">%&gt;%</span> </span>
<span id="cb19-62"><a href="counterfactual-simulation.html#cb19-62" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">&quot;claims&quot;</span>)),</span>
<span id="cb19-63"><a href="counterfactual-simulation.html#cb19-63" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">funs</span>(<span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">0</span>, <span class="fl">0.98</span>, <span class="fl">1.2</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb19-64"><a href="counterfactual-simulation.html#cb19-64" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;claims&quot;</span>, <span class="st">&quot;R_C&quot;</span>),</span>
<span id="cb19-65"><a href="counterfactual-simulation.html#cb19-65" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;claims&quot;</span>))</span>
<span id="cb19-66"><a href="counterfactual-simulation.html#cb19-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-67"><a href="counterfactual-simulation.html#cb19-67" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Calculate Base R_s</span></span>
<span id="cb19-68"><a href="counterfactual-simulation.html#cb19-68" aria-hidden="true" tabindex="-1"></a>  <span class="do">### Note that, for simplicity, assume that R0 is deterministic conditional on s. </span></span>
<span id="cb19-69"><a href="counterfactual-simulation.html#cb19-69" aria-hidden="true" tabindex="-1"></a>  <span class="do">### In reality, the spread of baseline R0 without monitoring may have subtle </span></span>
<span id="cb19-70"><a href="counterfactual-simulation.html#cb19-70" aria-hidden="true" tabindex="-1"></a>  <span class="do">### nonlinear effects on consumer choice, which we assume away</span></span>
<span id="cb19-71"><a href="counterfactual-simulation.html#cb19-71" aria-hidden="true" tabindex="-1"></a>  alpha_m0 <span class="ot">&lt;-</span> theta[<span class="dv">7</span><span class="sc">:</span><span class="dv">9</span>]</span>
<span id="cb19-72"><a href="counterfactual-simulation.html#cb19-72" aria-hidden="true" tabindex="-1"></a>  alpha_m1 <span class="ot">&lt;-</span> theta[<span class="dv">10</span><span class="sc">:</span><span class="dv">13</span>]</span>
<span id="cb19-73"><a href="counterfactual-simulation.html#cb19-73" aria-hidden="true" tabindex="-1"></a>  beta <span class="ot">&lt;-</span> theta[<span class="dv">14</span>]</span>
<span id="cb19-74"><a href="counterfactual-simulation.html#cb19-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-75"><a href="counterfactual-simulation.html#cb19-75" aria-hidden="true" tabindex="-1"></a>  R_s <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb19-76"><a href="counterfactual-simulation.html#cb19-76" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(m, x_1, x_2) <span class="sc">%&gt;%</span> </span>
<span id="cb19-77"><a href="counterfactual-simulation.html#cb19-77" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(score) <span class="sc">%&gt;%</span> </span>
<span id="cb19-78"><a href="counterfactual-simulation.html#cb19-78" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">&quot;score&quot;</span>)),</span>
<span id="cb19-79"><a href="counterfactual-simulation.html#cb19-79" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">funs</span>(<span class="fu">ifelse</span>(m <span class="sc">==</span> <span class="dv">0</span>,</span>
<span id="cb19-80"><a href="counterfactual-simulation.html#cb19-80" aria-hidden="true" tabindex="-1"></a>                                 (alpha_m0[<span class="dv">1</span>] <span class="sc">+</span> alpha_m0[<span class="dv">2</span>]<span class="sc">*</span>x_1 <span class="sc">+</span> alpha_m0[<span class="dv">3</span>]<span class="sc">*</span>x_2) <span class="sc">/</span> beta,</span>
<span id="cb19-81"><a href="counterfactual-simulation.html#cb19-81" aria-hidden="true" tabindex="-1"></a>                                 (alpha_m1[<span class="dv">1</span>] <span class="sc">+</span> alpha_m1[<span class="dv">2</span>]<span class="sc">*</span>x_1 <span class="sc">+</span> alpha_m1[<span class="dv">3</span>]<span class="sc">*</span>x_2 <span class="sc">+</span> alpha_m1[<span class="dv">4</span>]<span class="sc">*</span>.) <span class="sc">/</span> beta))) <span class="sc">%&gt;%</span></span>
<span id="cb19-82"><a href="counterfactual-simulation.html#cb19-82" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;score&quot;</span>, <span class="st">&quot;R_s&quot;</span>),</span>
<span id="cb19-83"><a href="counterfactual-simulation.html#cb19-83" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;score&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb19-84"><a href="counterfactual-simulation.html#cb19-84" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(m, x_1, x_2))</span>
<span id="cb19-85"><a href="counterfactual-simulation.html#cb19-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-86"><a href="counterfactual-simulation.html#cb19-86" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Calculate Base Renewal Price</span></span>
<span id="cb19-87"><a href="counterfactual-simulation.html#cb19-87" aria-hidden="true" tabindex="-1"></a>  price <span class="ot">&lt;-</span> df<span class="sc">$</span>price <span class="sc">*</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">dim</span>(df)[<span class="dv">1</span>] <span class="sc">*</span> L <span class="sc">*</span> K), <span class="at">nrow =</span> <span class="fu">dim</span>(df)[<span class="dv">1</span>])</span>
<span id="cb19-88"><a href="counterfactual-simulation.html#cb19-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(price) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">paste</span>(<span class="st">&quot;price&quot;</span>, <span class="dv">1</span><span class="sc">:</span>(L <span class="sc">*</span> K), <span class="at">sep =</span> <span class="st">&quot;_&quot;</span>))</span>
<span id="cb19-89"><a href="counterfactual-simulation.html#cb19-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-90"><a href="counterfactual-simulation.html#cb19-90" aria-hidden="true" tabindex="-1"></a>  price <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(price) <span class="sc">%&gt;%</span> </span>
<span id="cb19-91"><a href="counterfactual-simulation.html#cb19-91" aria-hidden="true" tabindex="-1"></a>    tibble<span class="sc">::</span><span class="fu">as_tibble</span>()</span>
<span id="cb19-92"><a href="counterfactual-simulation.html#cb19-92" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-93"><a href="counterfactual-simulation.html#cb19-93" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> price <span class="sc">*</span> R_C <span class="sc">*</span> R_s</span>
<span id="cb19-94"><a href="counterfactual-simulation.html#cb19-94" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-95"><a href="counterfactual-simulation.html#cb19-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(output)</span>
<span id="cb19-96"><a href="counterfactual-simulation.html#cb19-96" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-97"><a href="counterfactual-simulation.html#cb19-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-98"><a href="counterfactual-simulation.html#cb19-98" aria-hidden="true" tabindex="-1"></a>tmp_score <span class="ot">&lt;-</span> <span class="fu">sim_renewal_price</span>(df_t0, theta, cost_par, R, sim_lambda)</span></code></pre></div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="estimation.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": false,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
