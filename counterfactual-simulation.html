<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>4 Counterfactual Simulation | Monte Carlo Simulation: Jin and Vasserman (2021)</title>
  <meta name="description" content="4 Counterfactual Simulation | Monte Carlo Simulation: Jin and Vasserman (2021)" />
  <meta name="generator" content="bookdown 0.31 and GitBook 2.6.7" />

  <meta property="og:title" content="4 Counterfactual Simulation | Monte Carlo Simulation: Jin and Vasserman (2021)" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="4 Counterfactual Simulation | Monte Carlo Simulation: Jin and Vasserman (2021)" />
  
  
  

<meta name="author" content="Yuki KAYABA" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="estimation.html"/>

<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="generate-data-for-choice-model.html"><a href="generate-data-for-choice-model.html"><i class="fa fa-check"></i><b>1</b> Generate Data for Choice Model</a>
<ul>
<li class="chapter" data-level="1.1" data-path="generate-data-for-choice-model.html"><a href="generate-data-for-choice-model.html#generate-lambda"><i class="fa fa-check"></i><b>1.1</b> Generate <span class="math inline">\(\lambda\)</span></a></li>
<li class="chapter" data-level="1.2" data-path="generate-data-for-choice-model.html"><a href="generate-data-for-choice-model.html#generate-expectation-of-monitoring-score-and-out-of-pocket"><i class="fa fa-check"></i><b>1.2</b> Generate (Expectation of) Monitoring Score and Out-of-Pocket</a></li>
<li class="chapter" data-level="1.3" data-path="generate-data-for-choice-model.html"><a href="generate-data-for-choice-model.html#generate-choice-in-t-0"><i class="fa fa-check"></i><b>1.3</b> Generate Choice in <span class="math inline">\(t = 0\)</span></a></li>
<li class="chapter" data-level="1.4" data-path="generate-data-for-choice-model.html"><a href="generate-data-for-choice-model.html#generate-realization-of-cost-in-t-0"><i class="fa fa-check"></i><b>1.4</b> Generate Realization of Cost in <span class="math inline">\(t = 0\)</span></a></li>
<li class="chapter" data-level="1.5" data-path="generate-data-for-choice-model.html"><a href="generate-data-for-choice-model.html#generate-choice-in-t-1"><i class="fa fa-check"></i><b>1.5</b> Generate Choice in <span class="math inline">\(t = 1\)</span></a></li>
<li class="chapter" data-level="1.6" data-path="generate-data-for-choice-model.html"><a href="generate-data-for-choice-model.html#merge-choice-data"><i class="fa fa-check"></i><b>1.6</b> Merge Choice Data</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="generate-data-for-cost-model.html"><a href="generate-data-for-cost-model.html"><i class="fa fa-check"></i><b>2</b> Generate Data for Cost Model</a></li>
<li class="chapter" data-level="3" data-path="estimation.html"><a href="estimation.html"><i class="fa fa-check"></i><b>3</b> Estimation</a>
<ul>
<li class="chapter" data-level="3.1" data-path="estimation.html"><a href="estimation.html#fuctions"><i class="fa fa-check"></i><b>3.1</b> Fuctions</a></li>
<li class="chapter" data-level="3.2" data-path="estimation.html"><a href="estimation.html#optimization"><i class="fa fa-check"></i><b>3.2</b> Optimization</a></li>
<li class="chapter" data-level="3.3" data-path="estimation.html"><a href="estimation.html#estimation-results"><i class="fa fa-check"></i><b>3.3</b> Estimation Results</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="counterfactual-simulation.html"><a href="counterfactual-simulation.html"><i class="fa fa-check"></i><b>4</b> Counterfactual Simulation</a>
<ul>
<li class="chapter" data-level="4.1" data-path="counterfactual-simulation.html"><a href="counterfactual-simulation.html#welfare-calculation"><i class="fa fa-check"></i><b>4.1</b> Welfare Calculation</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Monte Carlo Simulation: Jin and Vasserman (2021)</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="counterfactual-simulation" class="section level1 hasAnchor" number="4">
<h1><span class="header-section-number">4</span> Counterfactual Simulation<a href="counterfactual-simulation.html#counterfactual-simulation" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="welfare-calculation" class="section level2 hasAnchor" number="4.1">
<h2><span class="header-section-number">4.1</span> Welfare Calculation<a href="counterfactual-simulation.html#welfare-calculation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Using our demand estimates, we evaluate the impact that the monitoring program has on consumer welfare and on firm profits in the status quo. To do this, we simulate a counterfactual scenario in which monitoring is not available, and compare it to the status quo baseline with monitoring.</p>
<ol style="list-style-type: decimal">
<li>For each driver <span class="math inline">\(i\)</span>, simulate random coefficients (private risk) <span class="math inline">\(L \in \mathbb{N}^{+}\)</span> times</li>
<li>For each draw <span class="math inline">\(l \in \{ 1, ..., L \}\)</span>, calculate ex-ante utility directly and the corresponding certainty equivalent. First-period choice probabilities are also calculated, which gives us the monitoring share. Expected cost of the first semester can be calculated directly. But we also need to form an expectation of the second-period cost (and prices) in order to calculate total surplus (and profit):</li>
<li>Simulate <span class="math inline">\(K \in \mathbb{N}^{+}\)</span> draws of first-period claim occurrence and monitoring score based on private risk . Each draw pins down the renewal price change that driver <span class="math inline">\(i\)</span> would face in the second period. All other prices remain constant. For each first-period choice <span class="math inline">\(d\)</span>, we can then calculate the second period choice probability and the corresponding expected cost</li>
</ol>
<ul>
<li>To do this, we need to generate choice sequence. First we calculate choice probability in <span class="math inline">\(t = 0\)</span> for each draw of <span class="math inline">\(\lambda\)</span></li>
</ul>
<table>
<thead>
<tr class="header">
<th align="center">i</th>
<th align="center">d</th>
<th align="center">t</th>
<th align="center">Prior</th>
<th align="center">Price</th>
<th align="center"><span class="math inline">\(\lambda_{1}\)</span></th>
<th align="center">…</th>
<th align="center"><span class="math inline">\(\lambda_{L}\)</span></th>
<th align="center">…</th>
<th align="center"><span class="math inline">\(\Pr_{1}\)</span></th>
<th align="center">…</th>
<th align="center"><span class="math inline">\(\Pr_{L}\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">1</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">3</td>
<td align="center">100</td>
<td align="center">0.04</td>
<td align="center">…</td>
<td align="center">0.02</td>
<td align="center">…</td>
<td align="center">0.25</td>
<td align="center">…</td>
<td align="center">0.20</td>
</tr>
<tr class="even">
<td align="center">1</td>
<td align="center">2</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">110</td>
<td align="center">0.05</td>
<td align="center">…</td>
<td align="center">0.03</td>
<td align="center">…</td>
<td align="center">0.05</td>
<td align="center">…</td>
<td align="center">0.10</td>
</tr>
<tr class="odd">
<td align="center">1</td>
<td align="center">3</td>
<td align="center">0</td>
<td align="center">2</td>
<td align="center">90</td>
<td align="center">0.05</td>
<td align="center">…</td>
<td align="center">0.03</td>
<td align="center">…</td>
<td align="center">0.35</td>
<td align="center">…</td>
<td align="center">0.40</td>
</tr>
<tr class="even">
<td align="center">1</td>
<td align="center">4</td>
<td align="center">0</td>
<td align="center">2</td>
<td align="center">95</td>
<td align="center">0.05</td>
<td align="center">…</td>
<td align="center">0.03</td>
<td align="center">…</td>
<td align="center">0.35</td>
<td align="center">…</td>
<td align="center">0.30</td>
</tr>
<tr class="odd">
<td align="center">2</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">130</td>
<td align="center">0.02</td>
<td align="center">…</td>
<td align="center">0.01</td>
<td align="center">…</td>
<td align="center">0.15</td>
<td align="center">…</td>
<td align="center">0.20</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="counterfactual-simulation.html#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of Draws</span></span>
<span id="cb19-2"><a href="counterfactual-simulation.html#cb19-2" aria-hidden="true" tabindex="-1"></a>L <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb19-3"><a href="counterfactual-simulation.html#cb19-3" aria-hidden="true" tabindex="-1"></a>K <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb19-4"><a href="counterfactual-simulation.html#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="counterfactual-simulation.html#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="do">## df for t = 0, 1</span></span>
<span id="cb19-6"><a href="counterfactual-simulation.html#cb19-6" aria-hidden="true" tabindex="-1"></a>df_t0 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb19-7"><a href="counterfactual-simulation.html#cb19-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(t <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb19-8"><a href="counterfactual-simulation.html#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="counterfactual-simulation.html#cb19-9" aria-hidden="true" tabindex="-1"></a>df_t1 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb19-10"><a href="counterfactual-simulation.html#cb19-10" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(t <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb19-11"><a href="counterfactual-simulation.html#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="counterfactual-simulation.html#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="do">## Simulate Private Risk Lambda</span></span>
<span id="cb19-13"><a href="counterfactual-simulation.html#cb19-13" aria-hidden="true" tabindex="-1"></a>sim_lambda <span class="ot">&lt;-</span> <span class="fu">gen_lambda</span>(df, cost_par, L) <span class="sc">%&gt;%</span> </span>
<span id="cb19-14"><a href="counterfactual-simulation.html#cb19-14" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>))</span>
<span id="cb19-15"><a href="counterfactual-simulation.html#cb19-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-16"><a href="counterfactual-simulation.html#cb19-16" aria-hidden="true" tabindex="-1"></a>sim_lambda_expand <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb19-17"><a href="counterfactual-simulation.html#cb19-17" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(sim_lambda)</span>
<span id="cb19-18"><a href="counterfactual-simulation.html#cb19-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-19"><a href="counterfactual-simulation.html#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(K <span class="sc">-</span> <span class="dv">1</span>)){</span>
<span id="cb19-20"><a href="counterfactual-simulation.html#cb19-20" aria-hidden="true" tabindex="-1"></a>  sim_lambda_expand <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(sim_lambda_expand, sim_lambda)</span>
<span id="cb19-21"><a href="counterfactual-simulation.html#cb19-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-22"><a href="counterfactual-simulation.html#cb19-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-23"><a href="counterfactual-simulation.html#cb19-23" aria-hidden="true" tabindex="-1"></a>column_order_lambda <span class="ot">&lt;-</span> sim_lambda_expand <span class="sc">%&gt;%</span> </span>
<span id="cb19-24"><a href="counterfactual-simulation.html#cb19-24" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb19-25"><a href="counterfactual-simulation.html#cb19-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb19-26"><a href="counterfactual-simulation.html#cb19-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sort</span>()</span>
<span id="cb19-27"><a href="counterfactual-simulation.html#cb19-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-28"><a href="counterfactual-simulation.html#cb19-28" aria-hidden="true" tabindex="-1"></a>sim_lambda_expand <span class="ot">&lt;-</span> sim_lambda_expand <span class="sc">%&gt;%</span> </span>
<span id="cb19-29"><a href="counterfactual-simulation.html#cb19-29" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="st">&quot;i&quot;</span>, <span class="st">&quot;d&quot;</span>, <span class="st">&quot;t&quot;</span>, <span class="st">&quot;m&quot;</span>, <span class="st">&quot;f&quot;</span>,</span>
<span id="cb19-30"><a href="counterfactual-simulation.html#cb19-30" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;x_1&quot;</span>, <span class="st">&quot;x_2&quot;</span>, <span class="st">&quot;x_3&quot;</span>, <span class="st">&quot;x_4&quot;</span>, </span>
<span id="cb19-31"><a href="counterfactual-simulation.html#cb19-31" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;price&quot;</span>, <span class="st">&quot;prior_firm&quot;</span>, <span class="st">&quot;choice&quot;</span>,</span>
<span id="cb19-32"><a href="counterfactual-simulation.html#cb19-32" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;claims&quot;</span>, <span class="st">&quot;score&quot;</span>, <span class="st">&quot;R_s&quot;</span>, <span class="st">&quot;R_C&quot;</span>,</span>
<span id="cb19-33"><a href="counterfactual-simulation.html#cb19-33" aria-hidden="true" tabindex="-1"></a>                <span class="fu">all_of</span>(column_order_lambda))</span>
<span id="cb19-34"><a href="counterfactual-simulation.html#cb19-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-35"><a href="counterfactual-simulation.html#cb19-35" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(sim_lambda_expand) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;i&quot;</span>, <span class="st">&quot;d&quot;</span>, <span class="st">&quot;t&quot;</span>, <span class="st">&quot;m&quot;</span>, <span class="st">&quot;f&quot;</span>,</span>
<span id="cb19-36"><a href="counterfactual-simulation.html#cb19-36" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">&quot;x_1&quot;</span>, <span class="st">&quot;x_2&quot;</span>, <span class="st">&quot;x_3&quot;</span>, <span class="st">&quot;x_4&quot;</span>, </span>
<span id="cb19-37"><a href="counterfactual-simulation.html#cb19-37" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">&quot;price&quot;</span>, <span class="st">&quot;prior_firm&quot;</span>, <span class="st">&quot;choice&quot;</span>,</span>
<span id="cb19-38"><a href="counterfactual-simulation.html#cb19-38" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">&quot;claims&quot;</span>, <span class="st">&quot;score&quot;</span>, <span class="st">&quot;R_s&quot;</span>, <span class="st">&quot;R_C&quot;</span>,</span>
<span id="cb19-39"><a href="counterfactual-simulation.html#cb19-39" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">paste</span>(<span class="fu">rep</span>(<span class="st">&quot;lambda&quot;</span>, L <span class="sc">*</span> K), </span>
<span id="cb19-40"><a href="counterfactual-simulation.html#cb19-40" aria-hidden="true" tabindex="-1"></a>                                       <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>L, K, <span class="at">each =</span> K), </span>
<span id="cb19-41"><a href="counterfactual-simulation.html#cb19-41" aria-hidden="true" tabindex="-1"></a>                                       <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>K, L),</span>
<span id="cb19-42"><a href="counterfactual-simulation.html#cb19-42" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">sep =</span> <span class="st">&quot;_&quot;</span>))</span>
<span id="cb19-43"><a href="counterfactual-simulation.html#cb19-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-44"><a href="counterfactual-simulation.html#cb19-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-45"><a href="counterfactual-simulation.html#cb19-45" aria-hidden="true" tabindex="-1"></a><span class="do">## Lambda with L columns</span></span>
<span id="cb19-46"><a href="counterfactual-simulation.html#cb19-46" aria-hidden="true" tabindex="-1"></a>sim_lambda_t0 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb19-47"><a href="counterfactual-simulation.html#cb19-47" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(sim_lambda) <span class="sc">%&gt;%</span> </span>
<span id="cb19-48"><a href="counterfactual-simulation.html#cb19-48" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(t <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb19-49"><a href="counterfactual-simulation.html#cb19-49" aria-hidden="true" tabindex="-1"></a>sim_lambda_t1 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb19-50"><a href="counterfactual-simulation.html#cb19-50" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(sim_lambda) <span class="sc">%&gt;%</span> </span>
<span id="cb19-51"><a href="counterfactual-simulation.html#cb19-51" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(t <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb19-52"><a href="counterfactual-simulation.html#cb19-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-53"><a href="counterfactual-simulation.html#cb19-53" aria-hidden="true" tabindex="-1"></a><span class="do">## Lambda with L * K columns</span></span>
<span id="cb19-54"><a href="counterfactual-simulation.html#cb19-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-55"><a href="counterfactual-simulation.html#cb19-55" aria-hidden="true" tabindex="-1"></a>sim_lambda_expand_t0 <span class="ot">&lt;-</span> sim_lambda_expand <span class="sc">%&gt;%</span> </span>
<span id="cb19-56"><a href="counterfactual-simulation.html#cb19-56" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(t <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb19-57"><a href="counterfactual-simulation.html#cb19-57" aria-hidden="true" tabindex="-1"></a>sim_lambda_expand_t1 <span class="ot">&lt;-</span> sim_lambda_expand <span class="sc">%&gt;%</span> </span>
<span id="cb19-58"><a href="counterfactual-simulation.html#cb19-58" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(t <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb19-59"><a href="counterfactual-simulation.html#cb19-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-60"><a href="counterfactual-simulation.html#cb19-60" aria-hidden="true" tabindex="-1"></a><span class="do">## Calculate Choice Probability in t = 0</span></span>
<span id="cb19-61"><a href="counterfactual-simulation.html#cb19-61" aria-hidden="true" tabindex="-1"></a>sim_choice_probability_t0 <span class="ot">&lt;-</span> <span class="cf">function</span>(df, theta, cost_par, lambda, Col){</span>
<span id="cb19-62"><a href="counterfactual-simulation.html#cb19-62" aria-hidden="true" tabindex="-1"></a> <span class="co"># Parameters</span></span>
<span id="cb19-63"><a href="counterfactual-simulation.html#cb19-63" aria-hidden="true" tabindex="-1"></a>  eta_f <span class="ot">&lt;-</span> theta[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>]</span>
<span id="cb19-64"><a href="counterfactual-simulation.html#cb19-64" aria-hidden="true" tabindex="-1"></a>  xi <span class="ot">&lt;-</span> theta[<span class="dv">5</span><span class="sc">:</span><span class="dv">6</span>]</span>
<span id="cb19-65"><a href="counterfactual-simulation.html#cb19-65" aria-hidden="true" tabindex="-1"></a>  alpha_m0 <span class="ot">&lt;-</span> theta[<span class="dv">7</span><span class="sc">:</span><span class="dv">9</span>]</span>
<span id="cb19-66"><a href="counterfactual-simulation.html#cb19-66" aria-hidden="true" tabindex="-1"></a>  alpha_m1 <span class="ot">&lt;-</span> theta[<span class="dv">10</span><span class="sc">:</span><span class="dv">13</span>]</span>
<span id="cb19-67"><a href="counterfactual-simulation.html#cb19-67" aria-hidden="true" tabindex="-1"></a>  beta <span class="ot">&lt;-</span> theta[<span class="dv">14</span>]</span>
<span id="cb19-68"><a href="counterfactual-simulation.html#cb19-68" aria-hidden="true" tabindex="-1"></a>  risk_aversion <span class="ot">&lt;-</span> theta[<span class="dv">15</span>]</span>
<span id="cb19-69"><a href="counterfactual-simulation.html#cb19-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-70"><a href="counterfactual-simulation.html#cb19-70" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Cost Parameters</span></span>
<span id="cb19-71"><a href="counterfactual-simulation.html#cb19-71" aria-hidden="true" tabindex="-1"></a>  theta_score <span class="ot">&lt;-</span> cost_par[<span class="dv">8</span><span class="sc">:</span><span class="dv">11</span>]</span>
<span id="cb19-72"><a href="counterfactual-simulation.html#cb19-72" aria-hidden="true" tabindex="-1"></a>  sigma_score <span class="ot">&lt;-</span> cost_par[<span class="dv">12</span>]</span>
<span id="cb19-73"><a href="counterfactual-simulation.html#cb19-73" aria-hidden="true" tabindex="-1"></a>  l0 <span class="ot">&lt;-</span> cost_par[<span class="dv">13</span>]</span>
<span id="cb19-74"><a href="counterfactual-simulation.html#cb19-74" aria-hidden="true" tabindex="-1"></a>  a_l <span class="ot">&lt;-</span> cost_par[<span class="dv">14</span>]</span>
<span id="cb19-75"><a href="counterfactual-simulation.html#cb19-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-76"><a href="counterfactual-simulation.html#cb19-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Price</span></span>
<span id="cb19-77"><a href="counterfactual-simulation.html#cb19-77" aria-hidden="true" tabindex="-1"></a>  price <span class="ot">&lt;-</span> df<span class="sc">$</span>price <span class="sc">*</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">dim</span>(df)[<span class="dv">1</span>] <span class="sc">*</span> Col), <span class="at">nrow =</span> <span class="fu">dim</span>(df)[<span class="dv">1</span>])</span>
<span id="cb19-78"><a href="counterfactual-simulation.html#cb19-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(price) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">paste</span>(<span class="st">&quot;price&quot;</span>, <span class="dv">1</span><span class="sc">:</span>Col, <span class="at">sep =</span> <span class="st">&quot;_&quot;</span>))</span>
<span id="cb19-79"><a href="counterfactual-simulation.html#cb19-79" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-80"><a href="counterfactual-simulation.html#cb19-80" aria-hidden="true" tabindex="-1"></a>  price <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(price) <span class="sc">%&gt;%</span> </span>
<span id="cb19-81"><a href="counterfactual-simulation.html#cb19-81" aria-hidden="true" tabindex="-1"></a>    tibble<span class="sc">::</span><span class="fu">as_tibble</span>()  </span>
<span id="cb19-82"><a href="counterfactual-simulation.html#cb19-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-83"><a href="counterfactual-simulation.html#cb19-83" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate Demand Friction</span></span>
<span id="cb19-84"><a href="counterfactual-simulation.html#cb19-84" aria-hidden="true" tabindex="-1"></a>  demand_friction <span class="ot">&lt;-</span> lambda <span class="sc">%&gt;%</span> </span>
<span id="cb19-85"><a href="counterfactual-simulation.html#cb19-85" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)),</span>
<span id="cb19-86"><a href="counterfactual-simulation.html#cb19-86" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">funs</span>(<span class="fu">ifelse</span>(f <span class="sc">==</span> prior_firm, </span>
<span id="cb19-87"><a href="counterfactual-simulation.html#cb19-87" aria-hidden="true" tabindex="-1"></a>                                 <span class="dv">0</span>,  </span>
<span id="cb19-88"><a href="counterfactual-simulation.html#cb19-88" aria-hidden="true" tabindex="-1"></a>                                 eta_f[<span class="dv">1</span>] <span class="sc">+</span> eta_f[<span class="dv">2</span>]<span class="sc">*</span>x_1 <span class="sc">+</span> eta_f[<span class="dv">3</span>]<span class="sc">*</span>x_2 <span class="sc">+</span> eta_f[<span class="dv">4</span>]<span class="sc">*</span>x_3) </span>
<span id="cb19-89"><a href="counterfactual-simulation.html#cb19-89" aria-hidden="true" tabindex="-1"></a>                          <span class="sc">+</span> <span class="fu">ifelse</span>(d <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> t <span class="sc">==</span> <span class="dv">0</span>, </span>
<span id="cb19-90"><a href="counterfactual-simulation.html#cb19-90" aria-hidden="true" tabindex="-1"></a>                                   xi[<span class="dv">1</span>] <span class="sc">+</span> xi[<span class="dv">2</span>]<span class="sc">*</span><span class="fu">log</span>(.), </span>
<span id="cb19-91"><a href="counterfactual-simulation.html#cb19-91" aria-hidden="true" tabindex="-1"></a>                                   <span class="dv">0</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb19-92"><a href="counterfactual-simulation.html#cb19-92" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;lambda&quot;</span>, <span class="st">&quot;demand_friction&quot;</span>), </span>
<span id="cb19-93"><a href="counterfactual-simulation.html#cb19-93" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb19-94"><a href="counterfactual-simulation.html#cb19-94" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">&quot;demand_friction&quot;</span>))</span>
<span id="cb19-95"><a href="counterfactual-simulation.html#cb19-95" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-96"><a href="counterfactual-simulation.html#cb19-96" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate E_score</span></span>
<span id="cb19-97"><a href="counterfactual-simulation.html#cb19-97" aria-hidden="true" tabindex="-1"></a>  E_score <span class="ot">&lt;-</span> lambda <span class="sc">%&gt;%</span> </span>
<span id="cb19-98"><a href="counterfactual-simulation.html#cb19-98" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)),</span>
<span id="cb19-99"><a href="counterfactual-simulation.html#cb19-99" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">funs</span>(<span class="fu">ifelse</span>(t <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> m <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb19-100"><a href="counterfactual-simulation.html#cb19-100" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">exp</span>(theta_score[<span class="dv">1</span>] <span class="sc">+</span> theta_score[<span class="dv">2</span>]<span class="sc">*</span><span class="fu">log</span>(.)</span>
<span id="cb19-101"><a href="counterfactual-simulation.html#cb19-101" aria-hidden="true" tabindex="-1"></a>                                     <span class="sc">+</span> theta_score[<span class="dv">3</span>]<span class="sc">*</span>x_1 <span class="sc">+</span> theta_score[<span class="dv">4</span>]<span class="sc">*</span>x_2</span>
<span id="cb19-102"><a href="counterfactual-simulation.html#cb19-102" aria-hidden="true" tabindex="-1"></a>                                     <span class="sc">+</span> sigma_score<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb19-103"><a href="counterfactual-simulation.html#cb19-103" aria-hidden="true" tabindex="-1"></a>                                 <span class="dv">0</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb19-104"><a href="counterfactual-simulation.html#cb19-104" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;lambda&quot;</span>, <span class="st">&quot;E_score&quot;</span>), </span>
<span id="cb19-105"><a href="counterfactual-simulation.html#cb19-105" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>))</span>
<span id="cb19-106"><a href="counterfactual-simulation.html#cb19-106" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-107"><a href="counterfactual-simulation.html#cb19-107" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate E_oop</span></span>
<span id="cb19-108"><a href="counterfactual-simulation.html#cb19-108" aria-hidden="true" tabindex="-1"></a>  E_oop <span class="ot">&lt;-</span> lambda <span class="sc">%&gt;%</span> </span>
<span id="cb19-109"><a href="counterfactual-simulation.html#cb19-109" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)),</span>
<span id="cb19-110"><a href="counterfactual-simulation.html#cb19-110" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">funs</span>(.<span class="sc">*</span><span class="fu">exp</span>(<span class="sc">-</span>.)<span class="sc">*</span>(l0<span class="sc">^</span>(a_l)<span class="sc">/</span>(a_l <span class="sc">-</span> <span class="dv">1</span>))<span class="sc">*</span>policy_limit<span class="sc">^</span>(<span class="sc">-</span>a_l <span class="sc">+</span> <span class="dv">1</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb19-111"><a href="counterfactual-simulation.html#cb19-111" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;lambda&quot;</span>, <span class="st">&quot;E_oop&quot;</span>), </span>
<span id="cb19-112"><a href="counterfactual-simulation.html#cb19-112" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb19-113"><a href="counterfactual-simulation.html#cb19-113" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">&quot;E_oop&quot;</span>))</span>
<span id="cb19-114"><a href="counterfactual-simulation.html#cb19-114" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-115"><a href="counterfactual-simulation.html#cb19-115" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate E_oop_sq</span></span>
<span id="cb19-116"><a href="counterfactual-simulation.html#cb19-116" aria-hidden="true" tabindex="-1"></a>  E_oop_sq <span class="ot">&lt;-</span> lambda <span class="sc">%&gt;%</span> </span>
<span id="cb19-117"><a href="counterfactual-simulation.html#cb19-117" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)),</span>
<span id="cb19-118"><a href="counterfactual-simulation.html#cb19-118" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">funs</span>(.<span class="sc">*</span><span class="fu">exp</span>(<span class="sc">-</span>.)<span class="sc">*</span>((<span class="dv">2</span> <span class="sc">*</span> l0<span class="sc">^</span>(a_l)) <span class="sc">/</span> ((a_l <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> (a_l <span class="sc">-</span> <span class="dv">1</span>))) <span class="sc">*</span> policy_limit<span class="sc">^</span>(<span class="sc">-</span>a_l <span class="sc">+</span> <span class="dv">2</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb19-119"><a href="counterfactual-simulation.html#cb19-119" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;lambda&quot;</span>, <span class="st">&quot;E_oop_sq&quot;</span>), </span>
<span id="cb19-120"><a href="counterfactual-simulation.html#cb19-120" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb19-121"><a href="counterfactual-simulation.html#cb19-121" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">&quot;E_oop_sq&quot;</span>))</span>
<span id="cb19-122"><a href="counterfactual-simulation.html#cb19-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-123"><a href="counterfactual-simulation.html#cb19-123" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate E_R_s</span></span>
<span id="cb19-124"><a href="counterfactual-simulation.html#cb19-124" aria-hidden="true" tabindex="-1"></a>  E_R_s <span class="ot">&lt;-</span> E_score <span class="sc">%&gt;%</span> </span>
<span id="cb19-125"><a href="counterfactual-simulation.html#cb19-125" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">&quot;E_score&quot;</span>)),</span>
<span id="cb19-126"><a href="counterfactual-simulation.html#cb19-126" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">funs</span>(<span class="fu">ifelse</span>(t <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> m <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb19-127"><a href="counterfactual-simulation.html#cb19-127" aria-hidden="true" tabindex="-1"></a>                                 (alpha_m1[<span class="dv">1</span>] <span class="sc">+</span> alpha_m1[<span class="dv">2</span>]<span class="sc">*</span>x_1 <span class="sc">+</span> alpha_m1[<span class="dv">3</span>]<span class="sc">*</span>x_2 <span class="sc">+</span> alpha_m1[<span class="dv">4</span>]<span class="sc">*</span>.) <span class="sc">/</span> beta,</span>
<span id="cb19-128"><a href="counterfactual-simulation.html#cb19-128" aria-hidden="true" tabindex="-1"></a>                                 (alpha_m0[<span class="dv">1</span>] <span class="sc">+</span> alpha_m0[<span class="dv">2</span>]<span class="sc">*</span>x_1 <span class="sc">+</span> alpha_m0[<span class="dv">3</span>]<span class="sc">*</span>x_2) <span class="sc">/</span> beta))) <span class="sc">%&gt;%</span> </span>
<span id="cb19-129"><a href="counterfactual-simulation.html#cb19-129" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;E_score&quot;</span>, <span class="st">&quot;E_R_s&quot;</span>), </span>
<span id="cb19-130"><a href="counterfactual-simulation.html#cb19-130" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;E_score&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb19-131"><a href="counterfactual-simulation.html#cb19-131" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">&quot;E_R_s&quot;</span>))</span>
<span id="cb19-132"><a href="counterfactual-simulation.html#cb19-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-133"><a href="counterfactual-simulation.html#cb19-133" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate E_R_s_sq</span></span>
<span id="cb19-134"><a href="counterfactual-simulation.html#cb19-134" aria-hidden="true" tabindex="-1"></a>  E_R_s_sq <span class="ot">&lt;-</span> E_score <span class="sc">%&gt;%</span> </span>
<span id="cb19-135"><a href="counterfactual-simulation.html#cb19-135" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">&quot;E_score&quot;</span>)),</span>
<span id="cb19-136"><a href="counterfactual-simulation.html#cb19-136" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">funs</span>(<span class="fu">ifelse</span>(t <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> m <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb19-137"><a href="counterfactual-simulation.html#cb19-137" aria-hidden="true" tabindex="-1"></a>                                 (alpha_m1[<span class="dv">1</span>] <span class="sc">+</span> alpha_m1[<span class="dv">2</span>]<span class="sc">*</span>x_1 <span class="sc">+</span> alpha_m1[<span class="dv">3</span>]<span class="sc">*</span>x_2 <span class="sc">+</span> alpha_m1[<span class="dv">4</span>]<span class="sc">*</span>.) <span class="sc">/</span> beta<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb19-138"><a href="counterfactual-simulation.html#cb19-138" aria-hidden="true" tabindex="-1"></a>                                 (alpha_m0[<span class="dv">1</span>] <span class="sc">+</span> alpha_m0[<span class="dv">2</span>]<span class="sc">*</span>x_1 <span class="sc">+</span> alpha_m0[<span class="dv">3</span>]<span class="sc">*</span>x_2) <span class="sc">/</span> beta<span class="sc">^</span><span class="dv">2</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb19-139"><a href="counterfactual-simulation.html#cb19-139" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;E_score&quot;</span>, <span class="st">&quot;E_R_s_sq&quot;</span>), </span>
<span id="cb19-140"><a href="counterfactual-simulation.html#cb19-140" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;E_score&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb19-141"><a href="counterfactual-simulation.html#cb19-141" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">&quot;E_R_s_sq&quot;</span>))  </span>
<span id="cb19-142"><a href="counterfactual-simulation.html#cb19-142" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-143"><a href="counterfactual-simulation.html#cb19-143" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate E_R_C</span></span>
<span id="cb19-144"><a href="counterfactual-simulation.html#cb19-144" aria-hidden="true" tabindex="-1"></a>  E_R_C <span class="ot">&lt;-</span> lambda <span class="sc">%&gt;%</span> </span>
<span id="cb19-145"><a href="counterfactual-simulation.html#cb19-145" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)),</span>
<span id="cb19-146"><a href="counterfactual-simulation.html#cb19-146" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">funs</span>(<span class="fl">0.98</span> <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>.) <span class="sc">+</span> <span class="fl">1.2</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">exp</span>(<span class="sc">-</span>.)))) <span class="sc">%&gt;%</span> </span>
<span id="cb19-147"><a href="counterfactual-simulation.html#cb19-147" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;lambda&quot;</span>, <span class="st">&quot;E_R_C&quot;</span>), </span>
<span id="cb19-148"><a href="counterfactual-simulation.html#cb19-148" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb19-149"><a href="counterfactual-simulation.html#cb19-149" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">&quot;E_R_C&quot;</span>))</span>
<span id="cb19-150"><a href="counterfactual-simulation.html#cb19-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-151"><a href="counterfactual-simulation.html#cb19-151" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate E_R_C_sq</span></span>
<span id="cb19-152"><a href="counterfactual-simulation.html#cb19-152" aria-hidden="true" tabindex="-1"></a>  E_R_C_sq <span class="ot">&lt;-</span> lambda <span class="sc">%&gt;%</span> </span>
<span id="cb19-153"><a href="counterfactual-simulation.html#cb19-153" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)),</span>
<span id="cb19-154"><a href="counterfactual-simulation.html#cb19-154" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">funs</span>(<span class="fl">0.98</span><span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>.) <span class="sc">+</span> <span class="fl">1.2</span><span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">exp</span>(<span class="sc">-</span>.)))) <span class="sc">%&gt;%</span> </span>
<span id="cb19-155"><a href="counterfactual-simulation.html#cb19-155" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;lambda&quot;</span>, <span class="st">&quot;E_R_C_sq&quot;</span>), </span>
<span id="cb19-156"><a href="counterfactual-simulation.html#cb19-156" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb19-157"><a href="counterfactual-simulation.html#cb19-157" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">&quot;E_R_C_sq&quot;</span>))</span>
<span id="cb19-158"><a href="counterfactual-simulation.html#cb19-158" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-159"><a href="counterfactual-simulation.html#cb19-159" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate E_h</span></span>
<span id="cb19-160"><a href="counterfactual-simulation.html#cb19-160" aria-hidden="true" tabindex="-1"></a>  E_h <span class="ot">&lt;-</span> <span class="sc">-</span> price <span class="sc">-</span> demand_friction <span class="sc">-</span> E_oop <span class="sc">-</span> E_R_s <span class="sc">*</span> E_R_C <span class="sc">*</span> price</span>
<span id="cb19-161"><a href="counterfactual-simulation.html#cb19-161" aria-hidden="true" tabindex="-1"></a>  E_h <span class="ot">&lt;-</span> E_h <span class="sc">%&gt;%</span> </span>
<span id="cb19-162"><a href="counterfactual-simulation.html#cb19-162" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;price&quot;</span>, <span class="st">&quot;E_h&quot;</span>), </span>
<span id="cb19-163"><a href="counterfactual-simulation.html#cb19-163" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;price&quot;</span>))</span>
<span id="cb19-164"><a href="counterfactual-simulation.html#cb19-164" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-165"><a href="counterfactual-simulation.html#cb19-165" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate E_h_sq</span></span>
<span id="cb19-166"><a href="counterfactual-simulation.html#cb19-166" aria-hidden="true" tabindex="-1"></a>  E_h_sq <span class="ot">&lt;-</span> price<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> demand_friction<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> E_oop_sq <span class="sc">+</span> E_R_s_sq<span class="sc">*</span>E_R_C_sq<span class="sc">*</span>price<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb19-167"><a href="counterfactual-simulation.html#cb19-167" aria-hidden="true" tabindex="-1"></a>  <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span>price<span class="sc">*</span>demand_friction <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span>price<span class="sc">*</span>E_oop <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span>price<span class="sc">*</span>(E_R_s<span class="sc">*</span>E_R_C<span class="sc">*</span>price)</span>
<span id="cb19-168"><a href="counterfactual-simulation.html#cb19-168" aria-hidden="true" tabindex="-1"></a>  <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span>demand_friction<span class="sc">*</span>E_oop <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span>demand_friction<span class="sc">*</span>(E_R_s<span class="sc">*</span>E_R_C<span class="sc">*</span>price)</span>
<span id="cb19-169"><a href="counterfactual-simulation.html#cb19-169" aria-hidden="true" tabindex="-1"></a>  <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span>E_oop<span class="sc">*</span>(E_R_s<span class="sc">*</span>E_R_C<span class="sc">*</span>price)</span>
<span id="cb19-170"><a href="counterfactual-simulation.html#cb19-170" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-171"><a href="counterfactual-simulation.html#cb19-171" aria-hidden="true" tabindex="-1"></a>  E_h_sq <span class="ot">&lt;-</span> E_h_sq <span class="sc">%&gt;%</span> </span>
<span id="cb19-172"><a href="counterfactual-simulation.html#cb19-172" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;price&quot;</span>, <span class="st">&quot;E_h_sq&quot;</span>), </span>
<span id="cb19-173"><a href="counterfactual-simulation.html#cb19-173" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;price&quot;</span>))</span>
<span id="cb19-174"><a href="counterfactual-simulation.html#cb19-174" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-175"><a href="counterfactual-simulation.html#cb19-175" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate v</span></span>
<span id="cb19-176"><a href="counterfactual-simulation.html#cb19-176" aria-hidden="true" tabindex="-1"></a>  v <span class="ot">&lt;-</span> (E_h <span class="sc">-</span> (risk_aversion <span class="sc">/</span> <span class="dv">2</span>) <span class="sc">*</span> E_h_sq) <span class="sc">%&gt;%</span> </span>
<span id="cb19-177"><a href="counterfactual-simulation.html#cb19-177" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;E_h&quot;</span>, <span class="st">&quot;v&quot;</span>), </span>
<span id="cb19-178"><a href="counterfactual-simulation.html#cb19-178" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;E_h&quot;</span>))</span>
<span id="cb19-179"><a href="counterfactual-simulation.html#cb19-179" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-180"><a href="counterfactual-simulation.html#cb19-180" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Calculate Choice Probability</span></span>
<span id="cb19-181"><a href="counterfactual-simulation.html#cb19-181" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb19-182"><a href="counterfactual-simulation.html#cb19-182" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(v) <span class="sc">%&gt;%</span> </span>
<span id="cb19-183"><a href="counterfactual-simulation.html#cb19-183" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">group_by</span>(i, t) <span class="sc">%&gt;%</span> </span>
<span id="cb19-184"><a href="counterfactual-simulation.html#cb19-184" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">&quot;v&quot;</span>)),</span>
<span id="cb19-185"><a href="counterfactual-simulation.html#cb19-185" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">funs</span>(<span class="fu">exp</span>(.) <span class="sc">/</span> <span class="fu">sum</span>(<span class="fu">exp</span>(.)))) <span class="sc">%&gt;%</span> </span>
<span id="cb19-186"><a href="counterfactual-simulation.html#cb19-186" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb19-187"><a href="counterfactual-simulation.html#cb19-187" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;v&quot;</span>, <span class="st">&quot;choice_probability&quot;</span>), </span>
<span id="cb19-188"><a href="counterfactual-simulation.html#cb19-188" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;v&quot;</span>))</span>
<span id="cb19-189"><a href="counterfactual-simulation.html#cb19-189" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-190"><a href="counterfactual-simulation.html#cb19-190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(output)</span>
<span id="cb19-191"><a href="counterfactual-simulation.html#cb19-191" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-192"><a href="counterfactual-simulation.html#cb19-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-193"><a href="counterfactual-simulation.html#cb19-193" aria-hidden="true" tabindex="-1"></a><span class="fu">sim_choice_probability_t0</span>(df_t0, theta, cost_par, sim_lambda_t0, L)</span></code></pre></div>
<ul>
<li>Next, we simulate <span class="math inline">\(K \in \mathbb{N}^{+}\)</span> draws of first-period claim occurrence and monitoring score based on private risk for each <span class="math inline">\(\lambda\)</span> (thus we simulate <span class="math inline">\(L \times K\)</span> claims and monitoiring score in total)</li>
</ul>
<table>
<thead>
<tr class="header">
<th align="center">i</th>
<th align="center">d</th>
<th align="center">t</th>
<th align="center"><span class="math inline">\(\lambda_{1}\)</span></th>
<th align="center">…</th>
<th align="center"><span class="math inline">\(\lambda_{L}\)</span></th>
<th align="center"><span class="math inline">\(Claim_{11}\)</span></th>
<th align="center">…</th>
<th align="center"><span class="math inline">\(Claim_{LK}\)</span></th>
<th align="center"><span class="math inline">\(Score_{11}\)</span></th>
<th align="center">…</th>
<th align="center"><span class="math inline">\(Score_{LK}\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">1</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">0.05</td>
<td align="center">…</td>
<td align="center">0.03</td>
<td align="center">0</td>
<td align="center">…</td>
<td align="center">1</td>
<td align="center">-3.0</td>
<td align="center">…</td>
<td align="center">-1.0</td>
</tr>
<tr class="even">
<td align="center">1</td>
<td align="center">2</td>
<td align="center">0</td>
<td align="center">0.05</td>
<td align="center">…</td>
<td align="center">0.03</td>
<td align="center">0</td>
<td align="center">…</td>
<td align="center">0</td>
<td align="center">0.0</td>
<td align="center">…</td>
<td align="center">0.0</td>
</tr>
<tr class="odd">
<td align="center">1</td>
<td align="center">3</td>
<td align="center">0</td>
<td align="center">0.05</td>
<td align="center">…</td>
<td align="center">0.03</td>
<td align="center">1</td>
<td align="center">…</td>
<td align="center">0</td>
<td align="center">0.0</td>
<td align="center">…</td>
<td align="center">0.0</td>
</tr>
<tr class="even">
<td align="center">1</td>
<td align="center">4</td>
<td align="center">0</td>
<td align="center">0.05</td>
<td align="center">…</td>
<td align="center">0.03</td>
<td align="center">0</td>
<td align="center">…</td>
<td align="center">0</td>
<td align="center">0.0</td>
<td align="center">…</td>
<td align="center">0.0</td>
</tr>
<tr class="odd">
<td align="center">2</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">0.02</td>
<td align="center">…</td>
<td align="center">0.01</td>
<td align="center">2</td>
<td align="center">…</td>
<td align="center">0</td>
<td align="center">-2.5</td>
<td align="center">…</td>
<td align="center">-1.2</td>
</tr>
</tbody>
</table>
<ul>
<li>Based on each claim and monitoring score, renewal price multiplier <span class="math inline">\(R_{0}\)</span> is calculated</li>
</ul>
<table>
<thead>
<tr class="header">
<th align="center">i</th>
<th align="center">d</th>
<th align="center">t</th>
<th align="center"><span class="math inline">\(R_{C, 11}\)</span></th>
<th align="center">…</th>
<th align="center"><span class="math inline">\(R_{C, LK}\)</span></th>
<th align="center"><span class="math inline">\(R_{s, 11}\)</span></th>
<th align="center">…</th>
<th align="center"><span class="math inline">\(R_{s, LK}\)</span></th>
<th align="center"><span class="math inline">\(R_{0, 11}\)</span></th>
<th align="center">…</th>
<th align="center"><span class="math inline">\(R_{0, LK}\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">1</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">0.98</td>
<td align="center">…</td>
<td align="center">1.20</td>
<td align="center">0.99</td>
<td align="center">…</td>
<td align="center">0.95</td>
<td align="center">0.97</td>
<td align="center">…</td>
<td align="center">1.15</td>
</tr>
<tr class="even">
<td align="center">1</td>
<td align="center">2</td>
<td align="center">0</td>
<td align="center">0.98</td>
<td align="center">…</td>
<td align="center">0.98</td>
<td align="center">1.02</td>
<td align="center">…</td>
<td align="center">0.98</td>
<td align="center">1.00</td>
<td align="center">…</td>
<td align="center">0.96</td>
</tr>
<tr class="odd">
<td align="center">1</td>
<td align="center">3</td>
<td align="center">0</td>
<td align="center">1.20</td>
<td align="center">…</td>
<td align="center">0.98</td>
<td align="center">1.02</td>
<td align="center">…</td>
<td align="center">0.98</td>
<td align="center">1.22</td>
<td align="center">…</td>
<td align="center">0.96</td>
</tr>
<tr class="even">
<td align="center">1</td>
<td align="center">4</td>
<td align="center">0</td>
<td align="center">0.98</td>
<td align="center">…</td>
<td align="center">0.98</td>
<td align="center">1.02</td>
<td align="center">…</td>
<td align="center">0.98</td>
<td align="center">1.00</td>
<td align="center">…</td>
<td align="center">0.96</td>
</tr>
<tr class="odd">
<td align="center">2</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">1.20</td>
<td align="center">…</td>
<td align="center">0.98</td>
<td align="center">0.87</td>
<td align="center">…</td>
<td align="center">0.90</td>
<td align="center">1.07</td>
<td align="center">…</td>
<td align="center">0.88</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="counterfactual-simulation.html#cb20-1" aria-hidden="true" tabindex="-1"></a>sim_renewal_price_multiplier <span class="ot">&lt;-</span> <span class="cf">function</span>(df, theta, cost_par, lambda, Col){</span>
<span id="cb20-2"><a href="counterfactual-simulation.html#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Generate Claims</span></span>
<span id="cb20-3"><a href="counterfactual-simulation.html#cb20-3" aria-hidden="true" tabindex="-1"></a>  lambda_mat <span class="ot">&lt;-</span> lambda <span class="sc">%&gt;%</span> </span>
<span id="cb20-4"><a href="counterfactual-simulation.html#cb20-4" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb20-5"><a href="counterfactual-simulation.html#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.matrix</span>()</span>
<span id="cb20-6"><a href="counterfactual-simulation.html#cb20-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-7"><a href="counterfactual-simulation.html#cb20-7" aria-hidden="true" tabindex="-1"></a>  claims <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rpois</span>(<span class="fu">dim</span>(df)[<span class="dv">1</span>]<span class="sc">*</span>Col, <span class="at">lambda =</span> lambda_mat), <span class="at">nrow =</span> <span class="fu">dim</span>(df)[<span class="dv">1</span>])</span>
<span id="cb20-8"><a href="counterfactual-simulation.html#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(claims) <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;claims&quot;</span>, <span class="dv">1</span><span class="sc">:</span>Col, <span class="at">sep =</span> <span class="st">&quot;_&quot;</span>)</span>
<span id="cb20-9"><a href="counterfactual-simulation.html#cb20-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-10"><a href="counterfactual-simulation.html#cb20-10" aria-hidden="true" tabindex="-1"></a>  claims <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(claims) <span class="sc">%&gt;%</span> </span>
<span id="cb20-11"><a href="counterfactual-simulation.html#cb20-11" aria-hidden="true" tabindex="-1"></a>    tibble<span class="sc">::</span><span class="fu">as_tibble</span>()  </span>
<span id="cb20-12"><a href="counterfactual-simulation.html#cb20-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-13"><a href="counterfactual-simulation.html#cb20-13" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Generate Monitoring Score</span></span>
<span id="cb20-14"><a href="counterfactual-simulation.html#cb20-14" aria-hidden="true" tabindex="-1"></a>  theta_score <span class="ot">&lt;-</span> cost_par[<span class="dv">8</span><span class="sc">:</span><span class="dv">11</span>]</span>
<span id="cb20-15"><a href="counterfactual-simulation.html#cb20-15" aria-hidden="true" tabindex="-1"></a>  sigma_score <span class="ot">&lt;-</span> cost_par[<span class="dv">12</span>]</span>
<span id="cb20-16"><a href="counterfactual-simulation.html#cb20-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-17"><a href="counterfactual-simulation.html#cb20-17" aria-hidden="true" tabindex="-1"></a>  mu_score <span class="ot">&lt;-</span> lambda <span class="sc">%&gt;%</span></span>
<span id="cb20-18"><a href="counterfactual-simulation.html#cb20-18" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)),</span>
<span id="cb20-19"><a href="counterfactual-simulation.html#cb20-19" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">funs</span>(theta_score[<span class="dv">1</span>] <span class="sc">+</span> theta_score[<span class="dv">2</span>]<span class="sc">*</span><span class="fu">log</span>(.)</span>
<span id="cb20-20"><a href="counterfactual-simulation.html#cb20-20" aria-hidden="true" tabindex="-1"></a>                          <span class="sc">+</span> theta_score[<span class="dv">3</span>]<span class="sc">*</span>x_1 <span class="sc">+</span> theta_score[<span class="dv">4</span>]<span class="sc">*</span>x_2)) <span class="sc">%&gt;%</span></span>
<span id="cb20-21"><a href="counterfactual-simulation.html#cb20-21" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;lambda&quot;</span>, <span class="st">&quot;mu_score&quot;</span>),</span>
<span id="cb20-22"><a href="counterfactual-simulation.html#cb20-22" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb20-23"><a href="counterfactual-simulation.html#cb20-23" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">&quot;mu_score&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb20-24"><a href="counterfactual-simulation.html#cb20-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.matrix</span>()</span>
<span id="cb20-25"><a href="counterfactual-simulation.html#cb20-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-26"><a href="counterfactual-simulation.html#cb20-26" aria-hidden="true" tabindex="-1"></a>  score <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rlnorm</span>(<span class="fu">dim</span>(df)[<span class="dv">1</span>]<span class="sc">*</span>Col, mu_score, sigma_score), <span class="at">nrow =</span> <span class="fu">dim</span>(df)[<span class="dv">1</span>])</span>
<span id="cb20-27"><a href="counterfactual-simulation.html#cb20-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(score) <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;score&quot;</span>, <span class="dv">1</span><span class="sc">:</span>Col, <span class="at">sep =</span> <span class="st">&quot;_&quot;</span>)</span>
<span id="cb20-28"><a href="counterfactual-simulation.html#cb20-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-29"><a href="counterfactual-simulation.html#cb20-29" aria-hidden="true" tabindex="-1"></a>  score <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(score) <span class="sc">%&gt;%</span></span>
<span id="cb20-30"><a href="counterfactual-simulation.html#cb20-30" aria-hidden="true" tabindex="-1"></a>    tibble<span class="sc">::</span><span class="fu">as_tibble</span>()</span>
<span id="cb20-31"><a href="counterfactual-simulation.html#cb20-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-32"><a href="counterfactual-simulation.html#cb20-32" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Calculate Claim Surcharge R_C</span></span>
<span id="cb20-33"><a href="counterfactual-simulation.html#cb20-33" aria-hidden="true" tabindex="-1"></a>  R_C <span class="ot">&lt;-</span> claims <span class="sc">%&gt;%</span> </span>
<span id="cb20-34"><a href="counterfactual-simulation.html#cb20-34" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">&quot;claims&quot;</span>)),</span>
<span id="cb20-35"><a href="counterfactual-simulation.html#cb20-35" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">funs</span>(<span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">0</span>, <span class="fl">0.98</span>, <span class="fl">1.2</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb20-36"><a href="counterfactual-simulation.html#cb20-36" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;claims&quot;</span>, <span class="st">&quot;R_C&quot;</span>),</span>
<span id="cb20-37"><a href="counterfactual-simulation.html#cb20-37" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;claims&quot;</span>))</span>
<span id="cb20-38"><a href="counterfactual-simulation.html#cb20-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-39"><a href="counterfactual-simulation.html#cb20-39" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Calculate Base R_s</span></span>
<span id="cb20-40"><a href="counterfactual-simulation.html#cb20-40" aria-hidden="true" tabindex="-1"></a>  <span class="do">### Note that, for simplicity, assume that R0 is deterministic conditional on s. </span></span>
<span id="cb20-41"><a href="counterfactual-simulation.html#cb20-41" aria-hidden="true" tabindex="-1"></a>  <span class="do">### In reality, the spread of baseline R0 without monitoring may have subtle </span></span>
<span id="cb20-42"><a href="counterfactual-simulation.html#cb20-42" aria-hidden="true" tabindex="-1"></a>  <span class="do">### nonlinear effects on consumer choice, which we assume away</span></span>
<span id="cb20-43"><a href="counterfactual-simulation.html#cb20-43" aria-hidden="true" tabindex="-1"></a>  alpha_m0 <span class="ot">&lt;-</span> theta[<span class="dv">7</span><span class="sc">:</span><span class="dv">9</span>]</span>
<span id="cb20-44"><a href="counterfactual-simulation.html#cb20-44" aria-hidden="true" tabindex="-1"></a>  alpha_m1 <span class="ot">&lt;-</span> theta[<span class="dv">10</span><span class="sc">:</span><span class="dv">13</span>]</span>
<span id="cb20-45"><a href="counterfactual-simulation.html#cb20-45" aria-hidden="true" tabindex="-1"></a>  beta <span class="ot">&lt;-</span> theta[<span class="dv">14</span>]</span>
<span id="cb20-46"><a href="counterfactual-simulation.html#cb20-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-47"><a href="counterfactual-simulation.html#cb20-47" aria-hidden="true" tabindex="-1"></a>  R_s <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb20-48"><a href="counterfactual-simulation.html#cb20-48" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(m, x_1, x_2) <span class="sc">%&gt;%</span> </span>
<span id="cb20-49"><a href="counterfactual-simulation.html#cb20-49" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(score) <span class="sc">%&gt;%</span> </span>
<span id="cb20-50"><a href="counterfactual-simulation.html#cb20-50" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">&quot;score&quot;</span>)),</span>
<span id="cb20-51"><a href="counterfactual-simulation.html#cb20-51" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">funs</span>(<span class="fu">ifelse</span>(m <span class="sc">==</span> <span class="dv">0</span>,</span>
<span id="cb20-52"><a href="counterfactual-simulation.html#cb20-52" aria-hidden="true" tabindex="-1"></a>                                 (alpha_m0[<span class="dv">1</span>] <span class="sc">+</span> alpha_m0[<span class="dv">2</span>]<span class="sc">*</span>x_1 <span class="sc">+</span> alpha_m0[<span class="dv">3</span>]<span class="sc">*</span>x_2) <span class="sc">/</span> beta,</span>
<span id="cb20-53"><a href="counterfactual-simulation.html#cb20-53" aria-hidden="true" tabindex="-1"></a>                                 (alpha_m1[<span class="dv">1</span>] <span class="sc">+</span> alpha_m1[<span class="dv">2</span>]<span class="sc">*</span>x_1 <span class="sc">+</span> alpha_m1[<span class="dv">3</span>]<span class="sc">*</span>x_2 <span class="sc">+</span> alpha_m1[<span class="dv">4</span>]<span class="sc">*</span>.) <span class="sc">/</span> beta))) <span class="sc">%&gt;%</span></span>
<span id="cb20-54"><a href="counterfactual-simulation.html#cb20-54" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;score&quot;</span>, <span class="st">&quot;R_s&quot;</span>),</span>
<span id="cb20-55"><a href="counterfactual-simulation.html#cb20-55" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;score&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb20-56"><a href="counterfactual-simulation.html#cb20-56" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(m, x_1, x_2))</span>
<span id="cb20-57"><a href="counterfactual-simulation.html#cb20-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-58"><a href="counterfactual-simulation.html#cb20-58" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ## Calculate Base Renewal Price</span></span>
<span id="cb20-59"><a href="counterfactual-simulation.html#cb20-59" aria-hidden="true" tabindex="-1"></a>  <span class="co"># price &lt;- df$price * matrix(rep(1, dim(df)[1] * L * K), nrow = dim(df)[1])</span></span>
<span id="cb20-60"><a href="counterfactual-simulation.html#cb20-60" aria-hidden="true" tabindex="-1"></a>  <span class="co"># colnames(price) &lt;- c(paste(&quot;price&quot;, 1:(L * K), sep = &quot;_&quot;))</span></span>
<span id="cb20-61"><a href="counterfactual-simulation.html#cb20-61" aria-hidden="true" tabindex="-1"></a>  <span class="co"># </span></span>
<span id="cb20-62"><a href="counterfactual-simulation.html#cb20-62" aria-hidden="true" tabindex="-1"></a>  <span class="co"># price &lt;- data.frame(price) %&gt;% </span></span>
<span id="cb20-63"><a href="counterfactual-simulation.html#cb20-63" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   tibble::as_tibble()</span></span>
<span id="cb20-64"><a href="counterfactual-simulation.html#cb20-64" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-65"><a href="counterfactual-simulation.html#cb20-65" aria-hidden="true" tabindex="-1"></a>  R_0 <span class="ot">&lt;-</span> (R_C <span class="sc">*</span> R_s) <span class="sc">%&gt;%</span></span>
<span id="cb20-66"><a href="counterfactual-simulation.html#cb20-66" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;R_C&quot;</span>, <span class="st">&quot;R_0&quot;</span>),</span>
<span id="cb20-67"><a href="counterfactual-simulation.html#cb20-67" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;R_C&quot;</span>))</span>
<span id="cb20-68"><a href="counterfactual-simulation.html#cb20-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-69"><a href="counterfactual-simulation.html#cb20-69" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb20-70"><a href="counterfactual-simulation.html#cb20-70" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(R_0) <span class="sc">%&gt;%</span> </span>
<span id="cb20-71"><a href="counterfactual-simulation.html#cb20-71" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">c</span>(<span class="st">&quot;i&quot;</span>, <span class="st">&quot;d&quot;</span>, <span class="fu">matches</span>(<span class="st">&quot;R_0&quot;</span>)))</span>
<span id="cb20-72"><a href="counterfactual-simulation.html#cb20-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-73"><a href="counterfactual-simulation.html#cb20-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(output)</span>
<span id="cb20-74"><a href="counterfactual-simulation.html#cb20-74" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-75"><a href="counterfactual-simulation.html#cb20-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-76"><a href="counterfactual-simulation.html#cb20-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-77"><a href="counterfactual-simulation.html#cb20-77" aria-hidden="true" tabindex="-1"></a><span class="fu">sim_renewal_price_multiplier</span>(df_t0, theta, cost_par, sim_lambda_expand_t0, L<span class="sc">*</span>K)</span></code></pre></div>
<ul>
<li>Renewal price itself is expanded to the following table:</li>
</ul>
<table>
<thead>
<tr class="header">
<th align="center">i</th>
<th align="center">d</th>
<th align="center">t</th>
<th align="center">Prior</th>
<th align="center">Prior_Price</th>
<th align="center"><span class="math inline">\(R_{0, 11}\)</span></th>
<th align="center">…</th>
<th align="center"><span class="math inline">\(R_{0, LK}\)</span></th>
<th align="center"><span class="math inline">\(Price_{11}\)</span></th>
<th align="center">…</th>
<th align="center"><span class="math inline">\(Price_{LK}\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">1</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">100</td>
<td align="center">0.97</td>
<td align="center">…</td>
<td align="center">1.15</td>
<td align="center">97</td>
<td align="center">…</td>
<td align="center">115</td>
</tr>
<tr class="even">
<td align="center">1</td>
<td align="center">2</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">90</td>
<td align="center">0.97</td>
<td align="center">…</td>
<td align="center">1.15</td>
<td align="center">87</td>
<td align="center">…</td>
<td align="center">105</td>
</tr>
<tr class="odd">
<td align="center">1</td>
<td align="center">3</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">95</td>
<td align="center">0.97</td>
<td align="center">…</td>
<td align="center">1.15</td>
<td align="center">92</td>
<td align="center">…</td>
<td align="center">105</td>
</tr>
<tr class="even">
<td align="center">1</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">2</td>
<td align="center">110</td>
<td align="center">1.00</td>
<td align="center">…</td>
<td align="center">0.96</td>
<td align="center">110</td>
<td align="center">…</td>
<td align="center">105</td>
</tr>
<tr class="odd">
<td align="center">1</td>
<td align="center">2</td>
<td align="center">1</td>
<td align="center">2</td>
<td align="center">90</td>
<td align="center">1.00</td>
<td align="center">…</td>
<td align="center">0.96</td>
<td align="center">90</td>
<td align="center">…</td>
<td align="center">85</td>
</tr>
<tr class="even">
<td align="center">1</td>
<td align="center">3</td>
<td align="center">1</td>
<td align="center">2</td>
<td align="center">95</td>
<td align="center">1.00</td>
<td align="center">…</td>
<td align="center">0.96</td>
<td align="center">95</td>
<td align="center">…</td>
<td align="center">90</td>
</tr>
<tr class="odd">
<td align="center">1</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">3</td>
<td align="center">110</td>
<td align="center">1.22</td>
<td align="center">…</td>
<td align="center">0.96</td>
<td align="center">130</td>
<td align="center">…</td>
<td align="center">105</td>
</tr>
<tr class="even">
<td align="center">1</td>
<td align="center">2</td>
<td align="center">1</td>
<td align="center">3</td>
<td align="center">90</td>
<td align="center">1.22</td>
<td align="center">…</td>
<td align="center">0.96</td>
<td align="center">110</td>
<td align="center">…</td>
<td align="center">85</td>
</tr>
<tr class="odd">
<td align="center">1</td>
<td align="center">3</td>
<td align="center">1</td>
<td align="center">3</td>
<td align="center">95</td>
<td align="center">1.22</td>
<td align="center">…</td>
<td align="center">0.96</td>
<td align="center">115</td>
<td align="center">…</td>
<td align="center">90</td>
</tr>
<tr class="even">
<td align="center">1</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">4</td>
<td align="center">110</td>
<td align="center">1.00</td>
<td align="center">…</td>
<td align="center">0.96</td>
<td align="center">110</td>
<td align="center">…</td>
<td align="center">105</td>
</tr>
<tr class="odd">
<td align="center">1</td>
<td align="center">2</td>
<td align="center">1</td>
<td align="center">4</td>
<td align="center">90</td>
<td align="center">1.00</td>
<td align="center">…</td>
<td align="center">0.96</td>
<td align="center">90</td>
<td align="center">…</td>
<td align="center">85</td>
</tr>
<tr class="even">
<td align="center">1</td>
<td align="center">3</td>
<td align="center">1</td>
<td align="center">4</td>
<td align="center">95</td>
<td align="center">1.00</td>
<td align="center">…</td>
<td align="center">0.96</td>
<td align="center">95</td>
<td align="center">…</td>
<td align="center">90</td>
</tr>
<tr class="odd">
<td align="center">2</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">130</td>
<td align="center">1.07</td>
<td align="center">…</td>
<td align="center">0.88</td>
<td align="center">137</td>
<td align="center">…</td>
<td align="center">105</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="counterfactual-simulation.html#cb21-1" aria-hidden="true" tabindex="-1"></a>prior_price <span class="ot">&lt;-</span> df_t0 <span class="sc">%&gt;%</span> </span>
<span id="cb21-2"><a href="counterfactual-simulation.html#cb21-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(i, d, price) <span class="sc">%&gt;%</span> </span>
<span id="cb21-3"><a href="counterfactual-simulation.html#cb21-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">prior_price =</span> price)</span>
<span id="cb21-4"><a href="counterfactual-simulation.html#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="counterfactual-simulation.html#cb21-5" aria-hidden="true" tabindex="-1"></a>renewal_price_multiplier <span class="ot">&lt;-</span> <span class="fu">sim_renewal_price_multiplier</span>(df_t0, theta, cost_par, sim_lambda_expand_t0, L<span class="sc">*</span>K)</span>
<span id="cb21-6"><a href="counterfactual-simulation.html#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="counterfactual-simulation.html#cb21-7" aria-hidden="true" tabindex="-1"></a>renewal_price <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span>N, <span class="at">d =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">t =</span> <span class="dv">1</span>, <span class="at">prior_choice =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb21-8"><a href="counterfactual-simulation.html#cb21-8" aria-hidden="true" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb21-9"><a href="counterfactual-simulation.html#cb21-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(i, prior_choice) <span class="sc">%&gt;%</span> </span>
<span id="cb21-10"><a href="counterfactual-simulation.html#cb21-10" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">key =</span> <span class="fu">ifelse</span>(d <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> prior_choice <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, d <span class="sc">+</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb21-11"><a href="counterfactual-simulation.html#cb21-11" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(prior_price, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;i&quot;</span>, <span class="st">&quot;key&quot;</span> <span class="ot">=</span> <span class="st">&quot;d&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb21-12"><a href="counterfactual-simulation.html#cb21-12" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(renewal_price_multiplier, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;i&quot;</span>, <span class="st">&quot;prior_choice&quot;</span> <span class="ot">=</span> <span class="st">&quot;d&quot;</span>))</span></code></pre></div>
<ul>
<li>Finally we calculate choice probability in <span class="math inline">\(t = 1\)</span> based on each renewal price and <span class="math inline">\(\lambda\)</span> in <span class="math inline">\(t = 1\)</span>. Note that <span class="math inline">\(\lambda\)</span> in <span class="math inline">\(t = 1\)</span> is different from that of <span class="math inline">\(t = 0\)</span>, and hence we need to draw again</li>
</ul>
<table>
<thead>
<tr class="header">
<th align="center">i</th>
<th align="center">d</th>
<th align="center">t</th>
<th align="center">Prior</th>
<th align="center"><span class="math inline">\(Price_{11}\)</span></th>
<th align="center">…</th>
<th align="center"><span class="math inline">\(Price_{LK}\)</span></th>
<th align="center"><span class="math inline">\(\lambda_{1}\)</span></th>
<th align="center">…</th>
<th align="center"><span class="math inline">\(\lambda_{L}\)</span></th>
<th align="center">…</th>
<th align="center"><span class="math inline">\(\Pr_{11}\)</span></th>
<th align="center">…</th>
<th align="center"><span class="math inline">\(\Pr_{LK}\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">1</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">97</td>
<td align="center">…</td>
<td align="center">115</td>
<td align="center">0.06</td>
<td align="center">…</td>
<td align="center">0.04</td>
<td align="center">…</td>
<td align="center">0.45</td>
<td align="center">…</td>
<td align="center">0.40</td>
</tr>
<tr class="even">
<td align="center">1</td>
<td align="center">2</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">87</td>
<td align="center">…</td>
<td align="center">105</td>
<td align="center">0.06</td>
<td align="center">…</td>
<td align="center">0.04</td>
<td align="center">…</td>
<td align="center">0.25</td>
<td align="center">…</td>
<td align="center">0.30</td>
</tr>
<tr class="odd">
<td align="center">1</td>
<td align="center">3</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">92</td>
<td align="center">…</td>
<td align="center">105</td>
<td align="center">0.06</td>
<td align="center">…</td>
<td align="center">0.04</td>
<td align="center">…</td>
<td align="center">0.30</td>
<td align="center">…</td>
<td align="center">0.30</td>
</tr>
<tr class="even">
<td align="center">1</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">2</td>
<td align="center">110</td>
<td align="center">…</td>
<td align="center">105</td>
<td align="center">0.06</td>
<td align="center">…</td>
<td align="center">0.04</td>
<td align="center">…</td>
<td align="center">0.25</td>
<td align="center">…</td>
<td align="center">0.20</td>
</tr>
<tr class="odd">
<td align="center">1</td>
<td align="center">2</td>
<td align="center">1</td>
<td align="center">2</td>
<td align="center">90</td>
<td align="center">…</td>
<td align="center">85</td>
<td align="center">0.06</td>
<td align="center">…</td>
<td align="center">0.04</td>
<td align="center">…</td>
<td align="center">0.25</td>
<td align="center">…</td>
<td align="center">0.40</td>
</tr>
<tr class="even">
<td align="center">1</td>
<td align="center">3</td>
<td align="center">1</td>
<td align="center">2</td>
<td align="center">95</td>
<td align="center">…</td>
<td align="center">90</td>
<td align="center">0.06</td>
<td align="center">…</td>
<td align="center">0.04</td>
<td align="center">…</td>
<td align="center">0.50</td>
<td align="center">…</td>
<td align="center">0.40</td>
</tr>
<tr class="odd">
<td align="center">1</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">3</td>
<td align="center">130</td>
<td align="center">…</td>
<td align="center">105</td>
<td align="center">0.06</td>
<td align="center">…</td>
<td align="center">0.04</td>
<td align="center">…</td>
<td align="center">0.20</td>
<td align="center">…</td>
<td align="center">0.10</td>
</tr>
<tr class="even">
<td align="center">1</td>
<td align="center">2</td>
<td align="center">1</td>
<td align="center">3</td>
<td align="center">110</td>
<td align="center">…</td>
<td align="center">85</td>
<td align="center">0.06</td>
<td align="center">…</td>
<td align="center">0.04</td>
<td align="center">…</td>
<td align="center">0.35</td>
<td align="center">…</td>
<td align="center">0.50</td>
</tr>
<tr class="odd">
<td align="center">1</td>
<td align="center">3</td>
<td align="center">1</td>
<td align="center">3</td>
<td align="center">115</td>
<td align="center">…</td>
<td align="center">90</td>
<td align="center">0.06</td>
<td align="center">…</td>
<td align="center">0.04</td>
<td align="center">…</td>
<td align="center">0.45</td>
<td align="center">…</td>
<td align="center">0.40</td>
</tr>
<tr class="even">
<td align="center">1</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">4</td>
<td align="center">110</td>
<td align="center">…</td>
<td align="center">105</td>
<td align="center">0.06</td>
<td align="center">…</td>
<td align="center">0.04</td>
<td align="center">…</td>
<td align="center">0.55</td>
<td align="center">…</td>
<td align="center">0.30</td>
</tr>
<tr class="odd">
<td align="center">1</td>
<td align="center">2</td>
<td align="center">1</td>
<td align="center">4</td>
<td align="center">90</td>
<td align="center">…</td>
<td align="center">85</td>
<td align="center">0.06</td>
<td align="center">…</td>
<td align="center">0.04</td>
<td align="center">…</td>
<td align="center">0.15</td>
<td align="center">…</td>
<td align="center">0.30</td>
</tr>
<tr class="even">
<td align="center">1</td>
<td align="center">3</td>
<td align="center">1</td>
<td align="center">4</td>
<td align="center">95</td>
<td align="center">…</td>
<td align="center">90</td>
<td align="center">0.06</td>
<td align="center">…</td>
<td align="center">0.04</td>
<td align="center">…</td>
<td align="center">0.35</td>
<td align="center">…</td>
<td align="center">0.40</td>
</tr>
<tr class="odd">
<td align="center">2</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">137</td>
<td align="center">…</td>
<td align="center">105</td>
<td align="center">0.03</td>
<td align="center">…</td>
<td align="center">0.07</td>
<td align="center">…</td>
<td align="center">0.25</td>
<td align="center">…</td>
<td align="center">0.20</td>
</tr>
</tbody>
</table>
<ul>
<li>Thus, while choice probability in <span class="math inline">\(t = 0\)</span> has <span class="math inline">\((4N \times L)\)</span> matrix form, choice probability in <span class="math inline">\(t = 1\)</span> is <span class="math inline">\((12N \times LK)\)</span> matrix, due to <span class="math inline">\(K\)</span> times draw of claims and monitoring score as well as path dependence of choice</li>
</ul>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="counterfactual-simulation.html#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Calculate Certainty Equivalent for Each Draw</span></span>
<span id="cb22-2"><a href="counterfactual-simulation.html#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="do">### theta_estを入れるのが正しいが挙動確認のためthetaを入れている</span></span>
<span id="cb22-3"><a href="counterfactual-simulation.html#cb22-3" aria-hidden="true" tabindex="-1"></a>cal_certainty_equivalent <span class="ot">&lt;-</span> <span class="cf">function</span>(df, theta, cost_par, R, lambda){</span>
<span id="cb22-4"><a href="counterfactual-simulation.html#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Risk Aversion</span></span>
<span id="cb22-5"><a href="counterfactual-simulation.html#cb22-5" aria-hidden="true" tabindex="-1"></a>  risk_aversion <span class="ot">&lt;-</span> theta[<span class="dv">15</span>]</span>
<span id="cb22-6"><a href="counterfactual-simulation.html#cb22-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-7"><a href="counterfactual-simulation.html#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Calculate CE</span></span>
<span id="cb22-8"><a href="counterfactual-simulation.html#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="do">### We apply `cal_v` to obtain v</span></span>
<span id="cb22-9"><a href="counterfactual-simulation.html#cb22-9" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> <span class="fu">cal_v</span>(df, theta, cost_par, R, lambda) <span class="sc">%&gt;%</span> </span>
<span id="cb22-10"><a href="counterfactual-simulation.html#cb22-10" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">&quot;v&quot;</span>)),</span>
<span id="cb22-11"><a href="counterfactual-simulation.html#cb22-11" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">funs</span>(<span class="dv">1</span> <span class="sc">/</span> risk_aversion <span class="sc">-</span> <span class="fu">sqrt</span>((<span class="dv">1</span> <span class="sc">/</span> risk_aversion<span class="sc">^</span><span class="dv">2</span>) <span class="sc">-</span> <span class="dv">2</span><span class="sc">*</span>. <span class="sc">/</span> risk_aversion))) <span class="sc">%&gt;%</span> </span>
<span id="cb22-12"><a href="counterfactual-simulation.html#cb22-12" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;v&quot;</span>, <span class="st">&quot;certatinty_equivalent&quot;</span>), </span>
<span id="cb22-13"><a href="counterfactual-simulation.html#cb22-13" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;v&quot;</span>))</span>
<span id="cb22-14"><a href="counterfactual-simulation.html#cb22-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-15"><a href="counterfactual-simulation.html#cb22-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(output)</span>
<span id="cb22-16"><a href="counterfactual-simulation.html#cb22-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-17"><a href="counterfactual-simulation.html#cb22-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-18"><a href="counterfactual-simulation.html#cb22-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-19"><a href="counterfactual-simulation.html#cb22-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-20"><a href="counterfactual-simulation.html#cb22-20" aria-hidden="true" tabindex="-1"></a><span class="co">#tmp_price &lt;- sim_renewal_price(df_t0, theta, cost_par, R, sim_lambda_expand)</span></span>
<span id="cb22-21"><a href="counterfactual-simulation.html#cb22-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-22"><a href="counterfactual-simulation.html#cb22-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate Choice Probability in t = 1</span></span>
<span id="cb22-23"><a href="counterfactual-simulation.html#cb22-23" aria-hidden="true" tabindex="-1"></a>cal_v_modified <span class="ot">&lt;-</span> <span class="cf">function</span>(df, theta, cost_par, R, lambda_t0, lambda_t1){</span>
<span id="cb22-24"><a href="counterfactual-simulation.html#cb22-24" aria-hidden="true" tabindex="-1"></a> <span class="co"># Parameters</span></span>
<span id="cb22-25"><a href="counterfactual-simulation.html#cb22-25" aria-hidden="true" tabindex="-1"></a>  eta_f <span class="ot">&lt;-</span> theta[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>]</span>
<span id="cb22-26"><a href="counterfactual-simulation.html#cb22-26" aria-hidden="true" tabindex="-1"></a>  xi <span class="ot">&lt;-</span> theta[<span class="dv">5</span><span class="sc">:</span><span class="dv">6</span>]</span>
<span id="cb22-27"><a href="counterfactual-simulation.html#cb22-27" aria-hidden="true" tabindex="-1"></a>  alpha_m0 <span class="ot">&lt;-</span> theta[<span class="dv">7</span><span class="sc">:</span><span class="dv">9</span>]</span>
<span id="cb22-28"><a href="counterfactual-simulation.html#cb22-28" aria-hidden="true" tabindex="-1"></a>  alpha_m1 <span class="ot">&lt;-</span> theta[<span class="dv">10</span><span class="sc">:</span><span class="dv">13</span>]</span>
<span id="cb22-29"><a href="counterfactual-simulation.html#cb22-29" aria-hidden="true" tabindex="-1"></a>  beta <span class="ot">&lt;-</span> theta[<span class="dv">14</span>]</span>
<span id="cb22-30"><a href="counterfactual-simulation.html#cb22-30" aria-hidden="true" tabindex="-1"></a>  risk_aversion <span class="ot">&lt;-</span> theta[<span class="dv">15</span>]</span>
<span id="cb22-31"><a href="counterfactual-simulation.html#cb22-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-32"><a href="counterfactual-simulation.html#cb22-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Cost Parameters</span></span>
<span id="cb22-33"><a href="counterfactual-simulation.html#cb22-33" aria-hidden="true" tabindex="-1"></a>  theta_score <span class="ot">&lt;-</span> cost_par[<span class="dv">8</span><span class="sc">:</span><span class="dv">11</span>]</span>
<span id="cb22-34"><a href="counterfactual-simulation.html#cb22-34" aria-hidden="true" tabindex="-1"></a>  sigma_score <span class="ot">&lt;-</span> cost_par[<span class="dv">12</span>]</span>
<span id="cb22-35"><a href="counterfactual-simulation.html#cb22-35" aria-hidden="true" tabindex="-1"></a>  l0 <span class="ot">&lt;-</span> cost_par[<span class="dv">13</span>]</span>
<span id="cb22-36"><a href="counterfactual-simulation.html#cb22-36" aria-hidden="true" tabindex="-1"></a>  a_l <span class="ot">&lt;-</span> cost_par[<span class="dv">14</span>]</span>
<span id="cb22-37"><a href="counterfactual-simulation.html#cb22-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-38"><a href="counterfactual-simulation.html#cb22-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Price</span></span>
<span id="cb22-39"><a href="counterfactual-simulation.html#cb22-39" aria-hidden="true" tabindex="-1"></a>  price <span class="ot">&lt;-</span> <span class="fu">sim_renewal_price</span>(df, theta, cost_par, R, lambda_t0)</span>
<span id="cb22-40"><a href="counterfactual-simulation.html#cb22-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-41"><a href="counterfactual-simulation.html#cb22-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate Demand Friction</span></span>
<span id="cb22-42"><a href="counterfactual-simulation.html#cb22-42" aria-hidden="true" tabindex="-1"></a>  demand_friction <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb22-43"><a href="counterfactual-simulation.html#cb22-43" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(lambda_t1, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;i&quot;</span>, <span class="st">&quot;f&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb22-44"><a href="counterfactual-simulation.html#cb22-44" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)),</span>
<span id="cb22-45"><a href="counterfactual-simulation.html#cb22-45" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">funs</span>(<span class="sc">~</span><span class="fu">ifelse</span>(f <span class="sc">==</span> prior_firm, </span>
<span id="cb22-46"><a href="counterfactual-simulation.html#cb22-46" aria-hidden="true" tabindex="-1"></a>                                 <span class="dv">0</span>,  </span>
<span id="cb22-47"><a href="counterfactual-simulation.html#cb22-47" aria-hidden="true" tabindex="-1"></a>                                 eta_f[<span class="dv">1</span>] <span class="sc">+</span> eta_f[<span class="dv">2</span>]<span class="sc">*</span>x_1 <span class="sc">+</span> eta_f[<span class="dv">3</span>]<span class="sc">*</span>x_2 <span class="sc">+</span> eta_f[<span class="dv">4</span>]<span class="sc">*</span>x_3) </span>
<span id="cb22-48"><a href="counterfactual-simulation.html#cb22-48" aria-hidden="true" tabindex="-1"></a>                          <span class="sc">+</span> <span class="fu">ifelse</span>(d <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> t <span class="sc">==</span> <span class="dv">0</span>, </span>
<span id="cb22-49"><a href="counterfactual-simulation.html#cb22-49" aria-hidden="true" tabindex="-1"></a>                                   xi[<span class="dv">1</span>] <span class="sc">+</span> xi[<span class="dv">2</span>]<span class="sc">*</span><span class="fu">log</span>(.), </span>
<span id="cb22-50"><a href="counterfactual-simulation.html#cb22-50" aria-hidden="true" tabindex="-1"></a>                                   <span class="dv">0</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb22-51"><a href="counterfactual-simulation.html#cb22-51" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;lambda&quot;</span>, <span class="st">&quot;demand_friction&quot;</span>), </span>
<span id="cb22-52"><a href="counterfactual-simulation.html#cb22-52" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb22-53"><a href="counterfactual-simulation.html#cb22-53" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">&quot;demand_friction&quot;</span>))</span>
<span id="cb22-54"><a href="counterfactual-simulation.html#cb22-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-55"><a href="counterfactual-simulation.html#cb22-55" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate E_score</span></span>
<span id="cb22-56"><a href="counterfactual-simulation.html#cb22-56" aria-hidden="true" tabindex="-1"></a>  E_score <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb22-57"><a href="counterfactual-simulation.html#cb22-57" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(lambda_t1, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;i&quot;</span>, <span class="st">&quot;f&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb22-58"><a href="counterfactual-simulation.html#cb22-58" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)),</span>
<span id="cb22-59"><a href="counterfactual-simulation.html#cb22-59" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">funs</span>(<span class="fu">ifelse</span>(t <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> m <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb22-60"><a href="counterfactual-simulation.html#cb22-60" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">exp</span>(theta_score[<span class="dv">1</span>] <span class="sc">+</span> theta_score[<span class="dv">2</span>]<span class="sc">*</span><span class="fu">log</span>(.)</span>
<span id="cb22-61"><a href="counterfactual-simulation.html#cb22-61" aria-hidden="true" tabindex="-1"></a>                                     <span class="sc">+</span> theta_score[<span class="dv">3</span>]<span class="sc">*</span>x_1 <span class="sc">+</span> theta_score[<span class="dv">4</span>]<span class="sc">*</span>x_2</span>
<span id="cb22-62"><a href="counterfactual-simulation.html#cb22-62" aria-hidden="true" tabindex="-1"></a>                                     <span class="sc">+</span> sigma_score<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb22-63"><a href="counterfactual-simulation.html#cb22-63" aria-hidden="true" tabindex="-1"></a>                                 <span class="dv">0</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb22-64"><a href="counterfactual-simulation.html#cb22-64" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;lambda&quot;</span>, <span class="st">&quot;E_score&quot;</span>), </span>
<span id="cb22-65"><a href="counterfactual-simulation.html#cb22-65" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>))</span>
<span id="cb22-66"><a href="counterfactual-simulation.html#cb22-66" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-67"><a href="counterfactual-simulation.html#cb22-67" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate E_oop</span></span>
<span id="cb22-68"><a href="counterfactual-simulation.html#cb22-68" aria-hidden="true" tabindex="-1"></a>  E_oop <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb22-69"><a href="counterfactual-simulation.html#cb22-69" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(lambda_t1, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;i&quot;</span>, <span class="st">&quot;f&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb22-70"><a href="counterfactual-simulation.html#cb22-70" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)),</span>
<span id="cb22-71"><a href="counterfactual-simulation.html#cb22-71" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">funs</span>(.<span class="sc">*</span><span class="fu">exp</span>(<span class="sc">-</span>.)<span class="sc">*</span>(l0<span class="sc">^</span>(a_l)<span class="sc">/</span>(a_l <span class="sc">-</span> <span class="dv">1</span>))<span class="sc">*</span>policy_limit<span class="sc">^</span>(<span class="sc">-</span>a_l <span class="sc">+</span> <span class="dv">1</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb22-72"><a href="counterfactual-simulation.html#cb22-72" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;lambda&quot;</span>, <span class="st">&quot;E_oop&quot;</span>), </span>
<span id="cb22-73"><a href="counterfactual-simulation.html#cb22-73" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb22-74"><a href="counterfactual-simulation.html#cb22-74" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">&quot;E_oop&quot;</span>))</span>
<span id="cb22-75"><a href="counterfactual-simulation.html#cb22-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-76"><a href="counterfactual-simulation.html#cb22-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate E_oop_sq</span></span>
<span id="cb22-77"><a href="counterfactual-simulation.html#cb22-77" aria-hidden="true" tabindex="-1"></a>  E_oop_sq <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb22-78"><a href="counterfactual-simulation.html#cb22-78" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(lambda_t1, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;i&quot;</span>, <span class="st">&quot;f&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb22-79"><a href="counterfactual-simulation.html#cb22-79" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)),</span>
<span id="cb22-80"><a href="counterfactual-simulation.html#cb22-80" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">funs</span>(.<span class="sc">*</span><span class="fu">exp</span>(<span class="sc">-</span>.)<span class="sc">*</span>((<span class="dv">2</span> <span class="sc">*</span> l0<span class="sc">^</span>(a_l)) <span class="sc">/</span> ((a_l <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> (a_l <span class="sc">-</span> <span class="dv">1</span>))) <span class="sc">*</span> policy_limit<span class="sc">^</span>(<span class="sc">-</span>a_l <span class="sc">+</span> <span class="dv">2</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb22-81"><a href="counterfactual-simulation.html#cb22-81" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;lambda&quot;</span>, <span class="st">&quot;E_oop_sq&quot;</span>), </span>
<span id="cb22-82"><a href="counterfactual-simulation.html#cb22-82" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb22-83"><a href="counterfactual-simulation.html#cb22-83" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">&quot;E_oop_sq&quot;</span>))</span>
<span id="cb22-84"><a href="counterfactual-simulation.html#cb22-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-85"><a href="counterfactual-simulation.html#cb22-85" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate E_R_s</span></span>
<span id="cb22-86"><a href="counterfactual-simulation.html#cb22-86" aria-hidden="true" tabindex="-1"></a>  E_R_s <span class="ot">&lt;-</span> E_score <span class="sc">%&gt;%</span> </span>
<span id="cb22-87"><a href="counterfactual-simulation.html#cb22-87" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">&quot;E_score&quot;</span>)),</span>
<span id="cb22-88"><a href="counterfactual-simulation.html#cb22-88" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">funs</span>(<span class="fu">ifelse</span>(t <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> m <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb22-89"><a href="counterfactual-simulation.html#cb22-89" aria-hidden="true" tabindex="-1"></a>                                 (alpha_m1[<span class="dv">1</span>] <span class="sc">+</span> alpha_m1[<span class="dv">2</span>]<span class="sc">*</span>x_1 <span class="sc">+</span> alpha_m1[<span class="dv">3</span>]<span class="sc">*</span>x_2 <span class="sc">+</span> alpha_m1[<span class="dv">4</span>]<span class="sc">*</span>.) <span class="sc">/</span> beta,</span>
<span id="cb22-90"><a href="counterfactual-simulation.html#cb22-90" aria-hidden="true" tabindex="-1"></a>                                 (alpha_m0[<span class="dv">1</span>] <span class="sc">+</span> alpha_m0[<span class="dv">2</span>]<span class="sc">*</span>x_1 <span class="sc">+</span> alpha_m0[<span class="dv">3</span>]<span class="sc">*</span>x_2) <span class="sc">/</span> beta))) <span class="sc">%&gt;%</span> </span>
<span id="cb22-91"><a href="counterfactual-simulation.html#cb22-91" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;E_score&quot;</span>, <span class="st">&quot;E_R_s&quot;</span>), </span>
<span id="cb22-92"><a href="counterfactual-simulation.html#cb22-92" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;E_score&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb22-93"><a href="counterfactual-simulation.html#cb22-93" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">&quot;E_R_s&quot;</span>))</span>
<span id="cb22-94"><a href="counterfactual-simulation.html#cb22-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-95"><a href="counterfactual-simulation.html#cb22-95" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate E_R_s_sq</span></span>
<span id="cb22-96"><a href="counterfactual-simulation.html#cb22-96" aria-hidden="true" tabindex="-1"></a>  E_R_s_sq <span class="ot">&lt;-</span> E_score <span class="sc">%&gt;%</span> </span>
<span id="cb22-97"><a href="counterfactual-simulation.html#cb22-97" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">&quot;E_score&quot;</span>)),</span>
<span id="cb22-98"><a href="counterfactual-simulation.html#cb22-98" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">funs</span>(<span class="fu">ifelse</span>(t <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> m <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb22-99"><a href="counterfactual-simulation.html#cb22-99" aria-hidden="true" tabindex="-1"></a>                                 (alpha_m1[<span class="dv">1</span>] <span class="sc">+</span> alpha_m1[<span class="dv">2</span>]<span class="sc">*</span>x_1 <span class="sc">+</span> alpha_m1[<span class="dv">3</span>]<span class="sc">*</span>x_2 <span class="sc">+</span> alpha_m1[<span class="dv">4</span>]<span class="sc">*</span>.) <span class="sc">/</span> beta<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb22-100"><a href="counterfactual-simulation.html#cb22-100" aria-hidden="true" tabindex="-1"></a>                                 (alpha_m0[<span class="dv">1</span>] <span class="sc">+</span> alpha_m0[<span class="dv">2</span>]<span class="sc">*</span>x_1 <span class="sc">+</span> alpha_m0[<span class="dv">3</span>]<span class="sc">*</span>x_2) <span class="sc">/</span> beta<span class="sc">^</span><span class="dv">2</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb22-101"><a href="counterfactual-simulation.html#cb22-101" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;E_score&quot;</span>, <span class="st">&quot;E_R_s_sq&quot;</span>), </span>
<span id="cb22-102"><a href="counterfactual-simulation.html#cb22-102" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;E_score&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb22-103"><a href="counterfactual-simulation.html#cb22-103" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">&quot;E_R_s_sq&quot;</span>))  </span>
<span id="cb22-104"><a href="counterfactual-simulation.html#cb22-104" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-105"><a href="counterfactual-simulation.html#cb22-105" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate E_R_C</span></span>
<span id="cb22-106"><a href="counterfactual-simulation.html#cb22-106" aria-hidden="true" tabindex="-1"></a>  E_R_C <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb22-107"><a href="counterfactual-simulation.html#cb22-107" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(lambda_t1, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;i&quot;</span>, <span class="st">&quot;f&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb22-108"><a href="counterfactual-simulation.html#cb22-108" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)),</span>
<span id="cb22-109"><a href="counterfactual-simulation.html#cb22-109" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">funs</span>(<span class="fl">0.98</span> <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>.) <span class="sc">+</span> <span class="fl">1.2</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">exp</span>(<span class="sc">-</span>.)))) <span class="sc">%&gt;%</span> </span>
<span id="cb22-110"><a href="counterfactual-simulation.html#cb22-110" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;lambda&quot;</span>, <span class="st">&quot;E_R_C&quot;</span>), </span>
<span id="cb22-111"><a href="counterfactual-simulation.html#cb22-111" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb22-112"><a href="counterfactual-simulation.html#cb22-112" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">&quot;E_R_C&quot;</span>))</span>
<span id="cb22-113"><a href="counterfactual-simulation.html#cb22-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-114"><a href="counterfactual-simulation.html#cb22-114" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate E_R_C_sq</span></span>
<span id="cb22-115"><a href="counterfactual-simulation.html#cb22-115" aria-hidden="true" tabindex="-1"></a>  E_R_C_sq <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb22-116"><a href="counterfactual-simulation.html#cb22-116" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(lambda_t1, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;i&quot;</span>, <span class="st">&quot;f&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb22-117"><a href="counterfactual-simulation.html#cb22-117" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)),</span>
<span id="cb22-118"><a href="counterfactual-simulation.html#cb22-118" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">funs</span>(<span class="fl">0.98</span><span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>.) <span class="sc">+</span> <span class="fl">1.2</span><span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">exp</span>(<span class="sc">-</span>.)))) <span class="sc">%&gt;%</span> </span>
<span id="cb22-119"><a href="counterfactual-simulation.html#cb22-119" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;lambda&quot;</span>, <span class="st">&quot;E_R_C_sq&quot;</span>), </span>
<span id="cb22-120"><a href="counterfactual-simulation.html#cb22-120" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb22-121"><a href="counterfactual-simulation.html#cb22-121" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">&quot;E_R_C_sq&quot;</span>))</span>
<span id="cb22-122"><a href="counterfactual-simulation.html#cb22-122" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-123"><a href="counterfactual-simulation.html#cb22-123" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate E_h</span></span>
<span id="cb22-124"><a href="counterfactual-simulation.html#cb22-124" aria-hidden="true" tabindex="-1"></a>  E_h <span class="ot">&lt;-</span> <span class="sc">-</span> price <span class="sc">-</span> demand_friction <span class="sc">-</span> E_oop <span class="sc">-</span> E_R_s <span class="sc">*</span> E_R_C <span class="sc">*</span> price</span>
<span id="cb22-125"><a href="counterfactual-simulation.html#cb22-125" aria-hidden="true" tabindex="-1"></a>  E_h <span class="ot">&lt;-</span> E_h <span class="sc">%&gt;%</span> </span>
<span id="cb22-126"><a href="counterfactual-simulation.html#cb22-126" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;price&quot;</span>, <span class="st">&quot;E_h&quot;</span>), </span>
<span id="cb22-127"><a href="counterfactual-simulation.html#cb22-127" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;price&quot;</span>))</span>
<span id="cb22-128"><a href="counterfactual-simulation.html#cb22-128" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-129"><a href="counterfactual-simulation.html#cb22-129" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate E_h_sq</span></span>
<span id="cb22-130"><a href="counterfactual-simulation.html#cb22-130" aria-hidden="true" tabindex="-1"></a>  E_h_sq <span class="ot">&lt;-</span> price<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> demand_friction<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> E_oop_sq <span class="sc">+</span> E_R_s_sq<span class="sc">*</span>E_R_C_sq<span class="sc">*</span>price<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb22-131"><a href="counterfactual-simulation.html#cb22-131" aria-hidden="true" tabindex="-1"></a>  <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span>price<span class="sc">*</span>demand_friction <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span>price<span class="sc">*</span>E_oop <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span>price<span class="sc">*</span>(E_R_s<span class="sc">*</span>E_R_C<span class="sc">*</span>price)</span>
<span id="cb22-132"><a href="counterfactual-simulation.html#cb22-132" aria-hidden="true" tabindex="-1"></a>  <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span>demand_friction<span class="sc">*</span>E_oop <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span>demand_friction<span class="sc">*</span>(E_R_s<span class="sc">*</span>E_R_C<span class="sc">*</span>price)</span>
<span id="cb22-133"><a href="counterfactual-simulation.html#cb22-133" aria-hidden="true" tabindex="-1"></a>  <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span>E_oop<span class="sc">*</span>(E_R_s<span class="sc">*</span>E_R_C<span class="sc">*</span>price)</span>
<span id="cb22-134"><a href="counterfactual-simulation.html#cb22-134" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-135"><a href="counterfactual-simulation.html#cb22-135" aria-hidden="true" tabindex="-1"></a>  E_h_sq <span class="ot">&lt;-</span> E_h_sq <span class="sc">%&gt;%</span> </span>
<span id="cb22-136"><a href="counterfactual-simulation.html#cb22-136" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;price&quot;</span>, <span class="st">&quot;E_h_sq&quot;</span>), </span>
<span id="cb22-137"><a href="counterfactual-simulation.html#cb22-137" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;price&quot;</span>))</span>
<span id="cb22-138"><a href="counterfactual-simulation.html#cb22-138" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-139"><a href="counterfactual-simulation.html#cb22-139" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate v</span></span>
<span id="cb22-140"><a href="counterfactual-simulation.html#cb22-140" aria-hidden="true" tabindex="-1"></a>  v <span class="ot">&lt;-</span> (E_h <span class="sc">-</span> (risk_aversion <span class="sc">/</span> <span class="dv">2</span>) <span class="sc">*</span> E_h_sq) <span class="sc">%&gt;%</span> </span>
<span id="cb22-141"><a href="counterfactual-simulation.html#cb22-141" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;E_h&quot;</span>, <span class="st">&quot;v&quot;</span>), </span>
<span id="cb22-142"><a href="counterfactual-simulation.html#cb22-142" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;E_h&quot;</span>))</span>
<span id="cb22-143"><a href="counterfactual-simulation.html#cb22-143" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-144"><a href="counterfactual-simulation.html#cb22-144" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb22-145"><a href="counterfactual-simulation.html#cb22-145" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(v)</span>
<span id="cb22-146"><a href="counterfactual-simulation.html#cb22-146" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-147"><a href="counterfactual-simulation.html#cb22-147" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(output)</span>
<span id="cb22-148"><a href="counterfactual-simulation.html#cb22-148" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-149"><a href="counterfactual-simulation.html#cb22-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-150"><a href="counterfactual-simulation.html#cb22-150" aria-hidden="true" tabindex="-1"></a>cal_choice_probability_modified <span class="ot">&lt;-</span> <span class="cf">function</span>(df, theta, cost_par, R, lambda_t0, lambda_t1){</span>
<span id="cb22-151"><a href="counterfactual-simulation.html#cb22-151" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Calculate v</span></span>
<span id="cb22-152"><a href="counterfactual-simulation.html#cb22-152" aria-hidden="true" tabindex="-1"></a>  v <span class="ot">&lt;-</span> <span class="fu">cal_v_modified</span>(df, theta, cost_par, R, lambda_t0, lambda_t1)</span>
<span id="cb22-153"><a href="counterfactual-simulation.html#cb22-153" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-154"><a href="counterfactual-simulation.html#cb22-154" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Calculate Choice Probability</span></span>
<span id="cb22-155"><a href="counterfactual-simulation.html#cb22-155" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> v <span class="sc">%&gt;%</span> </span>
<span id="cb22-156"><a href="counterfactual-simulation.html#cb22-156" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">group_by</span>(i, t) <span class="sc">%&gt;%</span> </span>
<span id="cb22-157"><a href="counterfactual-simulation.html#cb22-157" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">&quot;v&quot;</span>)),</span>
<span id="cb22-158"><a href="counterfactual-simulation.html#cb22-158" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">funs</span>(<span class="fu">exp</span>(.) <span class="sc">/</span> <span class="fu">sum</span>(<span class="fu">exp</span>(.)))) <span class="sc">%&gt;%</span> </span>
<span id="cb22-159"><a href="counterfactual-simulation.html#cb22-159" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb22-160"><a href="counterfactual-simulation.html#cb22-160" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;v&quot;</span>, <span class="st">&quot;choice_probability&quot;</span>), </span>
<span id="cb22-161"><a href="counterfactual-simulation.html#cb22-161" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;v&quot;</span>)) </span>
<span id="cb22-162"><a href="counterfactual-simulation.html#cb22-162" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-163"><a href="counterfactual-simulation.html#cb22-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-164"><a href="counterfactual-simulation.html#cb22-164" aria-hidden="true" tabindex="-1"></a>tmp_choice_prob <span class="ot">&lt;-</span> <span class="fu">cal_choice_probability_modified</span>(df_t0, theta, cost_par, R, sim_lambda_expand_t0, sim_lambda_expand_t1)</span></code></pre></div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="estimation.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": false,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
