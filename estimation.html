<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>2 Estimation | Monte Carlo Simulation: Jin and Vasserman (2021)</title>
  <meta name="description" content="2 Estimation | Monte Carlo Simulation: Jin and Vasserman (2021)" />
  <meta name="generator" content="bookdown 0.31 and GitBook 2.6.7" />

  <meta property="og:title" content="2 Estimation | Monte Carlo Simulation: Jin and Vasserman (2021)" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="2 Estimation | Monte Carlo Simulation: Jin and Vasserman (2021)" />
  
  
  

<meta name="author" content="Yuki KAYABA" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="generate-data.html"/>

<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="generate-data.html"><a href="generate-data.html"><i class="fa fa-check"></i><b>1</b> Generate Data</a>
<ul>
<li class="chapter" data-level="1.1" data-path="generate-data.html"><a href="generate-data.html#メモ"><i class="fa fa-check"></i><b>1.1</b> メモ</a></li>
<li class="chapter" data-level="1.2" data-path="generate-data.html"><a href="generate-data.html#generate-lambda"><i class="fa fa-check"></i><b>1.2</b> Generate <span class="math inline">\(\lambda\)</span></a></li>
<li class="chapter" data-level="1.3" data-path="generate-data.html"><a href="generate-data.html#generate-expectation-of-monitoring-score-and-out-of-pocket"><i class="fa fa-check"></i><b>1.3</b> Generate (Expectation of) Monitoring Score and Out-of-Pocket</a></li>
<li class="chapter" data-level="1.4" data-path="generate-data.html"><a href="generate-data.html#generate-choice-in-t-0"><i class="fa fa-check"></i><b>1.4</b> Generate Choice in <span class="math inline">\(t = 0\)</span></a></li>
<li class="chapter" data-level="1.5" data-path="generate-data.html"><a href="generate-data.html#generate-realization-of-cost-in-t-0"><i class="fa fa-check"></i><b>1.5</b> Generate Realization of Cost in <span class="math inline">\(t = 0\)</span></a></li>
<li class="chapter" data-level="1.6" data-path="generate-data.html"><a href="generate-data.html#generate-choice-in-t-1"><i class="fa fa-check"></i><b>1.6</b> Generate Choice in <span class="math inline">\(t = 1\)</span></a></li>
<li class="chapter" data-level="1.7" data-path="generate-data.html"><a href="generate-data.html#merge-choice-data"><i class="fa fa-check"></i><b>1.7</b> Merge Choice Data</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="estimation.html"><a href="estimation.html"><i class="fa fa-check"></i><b>2</b> Estimation</a>
<ul>
<li class="chapter" data-level="2.1" data-path="estimation.html"><a href="estimation.html#fuctions"><i class="fa fa-check"></i><b>2.1</b> Fuctions</a></li>
<li class="chapter" data-level="2.2" data-path="estimation.html"><a href="estimation.html#optimization"><i class="fa fa-check"></i><b>2.2</b> Optimization</a></li>
<li class="chapter" data-level="2.3" data-path="estimation.html"><a href="estimation.html#estimation-results"><i class="fa fa-check"></i><b>2.3</b> Estimation Results</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Monte Carlo Simulation: Jin and Vasserman (2021)</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="estimation" class="section level1 hasAnchor" number="2">
<h1><span class="header-section-number">2</span> Estimation<a href="estimation.html#estimation" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<ul>
<li>Now we estimate the choice model, using data we generate</li>
<li>Again, the choice model in the paper is as follows:</li>
</ul>
<p><span class="math display">\[
\begin{align}
u_{idt}(C, s) &amp;= u_{\gamma}(w_{it} + h_{idt}(C, s)) \\
h_{idt}(C, s) &amp;= -p_{idt} - \mathbf{1}_{d, t-1} \cdot \psi_{idt} - e(C, y_{d}) - p_{idt} \cdot R_{idt}(C, s) \\
\text{where } \psi_{idt} &amp;= \mathbf{1}_{d, t-1} \cdot \eta_{0} + \mathbf{1}_{f_{d}, t-1} \cdot \eta_{it} + \mathbf{1}_{m_{d}} \cdot \mathbf{1}_{t=0} \cdot \xi_{it}
\end{align}
\]</span></p>
<ul>
<li>At each period <span class="math inline">\(t\)</span>, consumer <span class="math inline">\(i\)</span> chooses <span class="math inline">\(d\)</span> so as to maximize her expected utility:</li>
</ul>
<p><span class="math display">\[
\begin{align}
d_{it} &amp;= \mathop{\rm argmax}\limits_{d \in D_{it}} \left\{ v_{idt} + \varepsilon_{idt} \right\} \\
\text{where } v_{idt} &amp;= \mathbb{E}_{C, s}[u_{idt}(C, s)] = \mathbb{E}[h_{idt}] -\frac{\gamma}{2}\mathbb{E}[h_{idt}^{2}]
\end{align}
\]</span></p>
<ul>
<li><p>We estimate the model by simulated maximum likelihood method. In doing so, we adopt a two-step estimation procedure since the cost model is easier to estimate but requires a large amount of data, while the demand model is making use of rich variations in choice but computationally demanding.</p></li>
<li><p>Therefore, we estimate risk and monitoring score parameters <span class="math inline">\((\theta_{\lambda}, \sigma_{\lambda}, \theta_{s}, \sigma_{s})\)</span> first.</p></li>
<li><p>Then, we feed the estimates into the demand models as truth.</p></li>
<li><p>The overall log likelihood function is expressed as follows:</p></li>
</ul>
<p><span class="math display">\[
\begin{align}
    \mathscr{L}_{i} = \sum_{t \leq T_{i}} \int_{\lambda} \underbrace{\mathscr{L}(R_{it}, s_{i}, C_{it}, d_{it} \mid \lambda, \psi, x_{it}, p_{it}, D_{it}, d_{i, t-1} ; \Theta)}_{(A): \text{obs. stoc outcome}} \cdot \underbrace{g_{\lambda}(\lambda \mid x_{it} ; \theta_{\lambda}, \sigma_{\lambda})}_{(B): \text{latent var.}} d\lambda
\end{align}
\]</span></p>
<ul>
<li>We can decompose the likelihood component A as follows:</li>
</ul>
<p><span class="math display">\[
\begin{align}
    (A) = &amp; \ln \Pr(d_{it} \mid \lambda, x_{it}, p_{it}, D_{it}, d_{i, t-1}; a, \psi_{0}, \psi_{1}, \theta_{\eta}, \theta_{\xi}, \alpha, \theta_{\beta}) \notag \\
    &amp; + \ln \Pr(C_{it} \mid \lambda, x_{it}) + \ln g(l_{it} \mid d_{it}, x_{it}; \alpha, \theta_{\beta}) \notag \\
    &amp; + \ln g_{s}(s_{i} \mid \lambda, x_{it}; \theta_{s}, \sigma_{s}) + \ln g_{R}(R_{idt} \mid C_{it}, s_{i}, \lambda, x_{it}; \theta_{R}, \theta_{R, m}, \sigma_{R})
\end{align}
\]</span></p>
<div id="fuctions" class="section level2 hasAnchor" number="2.1">
<h2><span class="header-section-number">2.1</span> Fuctions<a href="estimation.html#fuctions" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>To estimate the choice model, we write the following functions:
<ul>
<li><code>gen_lambda</code> is a function that draws unobserved consumer risk <span class="math inline">\(\lambda\)</span>. In this function, we draw <span class="math inline">\(\lambda\)</span> for <span class="math inline">\(R\)</span> times</li>
<li><code>LL_choice</code> is a function that calculates choice probability that a consumer chooses each plan for each draw of <span class="math inline">\(\lambda\)</span></li>
<li><code>LL_renewal_price</code> is a function that calculates choice probability that a consumer chooses each plan for each draw of <span class="math inline">\(\lambda\)</span></li>
<li><code>SLL</code> is a function that calculates the simulated log-likelihood of consumer’s choice. We maximize this fucntion to get the estimates of choice model parameters</li>
</ul></li>
<li>Note that when optimizing an objective function, it is important to keep the realizations of the shocks the same across the evaluations of the objective function. If the realization of the shocks differ across the objective function evaluations, the optimization algorithm will not converge because it cannot distinguish the change in the value of the objective function due to the difference in the parameters and the difference in the realized shocks</li>
<li>To avoid this problem, we generate <span class="math inline">\(\lambda\)</span> outside the optimization algorithm</li>
</ul>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="estimation.html#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Generate Lambda</span></span>
<span id="cb16-2"><a href="estimation.html#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="estimation.html#cb16-3" aria-hidden="true" tabindex="-1"></a>gen_lambda <span class="ot">&lt;-</span> <span class="cf">function</span>(df, cost_par, R){</span>
<span id="cb16-4"><a href="estimation.html#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Parameters</span></span>
<span id="cb16-5"><a href="estimation.html#cb16-5" aria-hidden="true" tabindex="-1"></a>  theta_lambda <span class="ot">&lt;-</span> cost_par[<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>]</span>
<span id="cb16-6"><a href="estimation.html#cb16-6" aria-hidden="true" tabindex="-1"></a>  sigma_lambda <span class="ot">&lt;-</span> cost_par[<span class="dv">7</span>]</span>
<span id="cb16-7"><a href="estimation.html#cb16-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-8"><a href="estimation.html#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate mu_lambda</span></span>
<span id="cb16-9"><a href="estimation.html#cb16-9" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb16-10"><a href="estimation.html#cb16-10" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">mu_lambda =</span> theta_lambda[<span class="dv">1</span>]</span>
<span id="cb16-11"><a href="estimation.html#cb16-11" aria-hidden="true" tabindex="-1"></a>                  <span class="sc">+</span> theta_lambda[<span class="dv">2</span>]<span class="sc">*</span>x_1 <span class="sc">+</span> theta_lambda[<span class="dv">3</span>]<span class="sc">*</span>x_2</span>
<span id="cb16-12"><a href="estimation.html#cb16-12" aria-hidden="true" tabindex="-1"></a>                  <span class="sc">+</span> theta_lambda[<span class="dv">4</span>]<span class="sc">*</span>x_3 <span class="sc">+</span> theta_lambda[<span class="dv">5</span>]<span class="sc">*</span>x_4</span>
<span id="cb16-13"><a href="estimation.html#cb16-13" aria-hidden="true" tabindex="-1"></a>                  <span class="sc">+</span> theta_lambda[<span class="dv">6</span>]<span class="sc">*</span><span class="fu">ifelse</span>(m <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> t <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb16-14"><a href="estimation.html#cb16-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-15"><a href="estimation.html#cb16-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate epsilon_lambda (draw R times)</span></span>
<span id="cb16-16"><a href="estimation.html#cb16-16" aria-hidden="true" tabindex="-1"></a>  epsilon_lambda <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(N <span class="sc">*</span> R, <span class="dv">0</span>, sigma_lambda), <span class="at">nrow =</span> N)</span>
<span id="cb16-17"><a href="estimation.html#cb16-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(epsilon_lambda) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">paste</span>(<span class="st">&quot;lambda&quot;</span>, <span class="dv">1</span><span class="sc">:</span>R, <span class="at">sep =</span> <span class="st">&quot;_&quot;</span>))</span>
<span id="cb16-18"><a href="estimation.html#cb16-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-19"><a href="estimation.html#cb16-19" aria-hidden="true" tabindex="-1"></a>  epsilon_lambda <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">expand_grid</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span>N), epsilon_lambda) <span class="sc">%&gt;%</span> </span>
<span id="cb16-20"><a href="estimation.html#cb16-20" aria-hidden="true" tabindex="-1"></a>    tibble<span class="sc">::</span><span class="fu">as_tibble</span>()</span>
<span id="cb16-21"><a href="estimation.html#cb16-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-22"><a href="estimation.html#cb16-22" aria-hidden="true" tabindex="-1"></a>  <span class="do">## lambda</span></span>
<span id="cb16-23"><a href="estimation.html#cb16-23" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> output <span class="sc">%&gt;%</span></span>
<span id="cb16-24"><a href="estimation.html#cb16-24" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(epsilon_lambda, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;i&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb16-25"><a href="estimation.html#cb16-25" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate_at</span>(<span class="at">.vars =</span> <span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)),</span>
<span id="cb16-26"><a href="estimation.html#cb16-26" aria-hidden="true" tabindex="-1"></a>                     <span class="at">.funs =</span> <span class="sc">~</span> <span class="fu">exp</span>(mu_lambda <span class="sc">+</span> .)) <span class="sc">%&gt;%</span> </span>
<span id="cb16-27"><a href="estimation.html#cb16-27" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>mu_lambda)</span>
<span id="cb16-28"><a href="estimation.html#cb16-28" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb16-29"><a href="estimation.html#cb16-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(output)</span>
<span id="cb16-30"><a href="estimation.html#cb16-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-31"><a href="estimation.html#cb16-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-32"><a href="estimation.html#cb16-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Log-likelihood for Choice Probability</span></span>
<span id="cb16-33"><a href="estimation.html#cb16-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-34"><a href="estimation.html#cb16-34" aria-hidden="true" tabindex="-1"></a>LL_choice <span class="ot">&lt;-</span> <span class="cf">function</span>(df, theta, cost_par, lambda){</span>
<span id="cb16-35"><a href="estimation.html#cb16-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Parameters</span></span>
<span id="cb16-36"><a href="estimation.html#cb16-36" aria-hidden="true" tabindex="-1"></a>  eta_f <span class="ot">&lt;-</span> theta[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>]</span>
<span id="cb16-37"><a href="estimation.html#cb16-37" aria-hidden="true" tabindex="-1"></a>  xi <span class="ot">&lt;-</span> theta[<span class="dv">5</span><span class="sc">:</span><span class="dv">6</span>]</span>
<span id="cb16-38"><a href="estimation.html#cb16-38" aria-hidden="true" tabindex="-1"></a>  alpha_m0 <span class="ot">&lt;-</span> theta[<span class="dv">7</span><span class="sc">:</span><span class="dv">9</span>]</span>
<span id="cb16-39"><a href="estimation.html#cb16-39" aria-hidden="true" tabindex="-1"></a>  alpha_m1 <span class="ot">&lt;-</span> theta[<span class="dv">10</span><span class="sc">:</span><span class="dv">13</span>]</span>
<span id="cb16-40"><a href="estimation.html#cb16-40" aria-hidden="true" tabindex="-1"></a>  beta <span class="ot">&lt;-</span> theta[<span class="dv">14</span>]</span>
<span id="cb16-41"><a href="estimation.html#cb16-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-42"><a href="estimation.html#cb16-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Cost Parameters</span></span>
<span id="cb16-43"><a href="estimation.html#cb16-43" aria-hidden="true" tabindex="-1"></a>  theta_score <span class="ot">&lt;-</span> cost_par[<span class="dv">8</span><span class="sc">:</span><span class="dv">11</span>]</span>
<span id="cb16-44"><a href="estimation.html#cb16-44" aria-hidden="true" tabindex="-1"></a>  sigma_score <span class="ot">&lt;-</span> cost_par[<span class="dv">12</span>]</span>
<span id="cb16-45"><a href="estimation.html#cb16-45" aria-hidden="true" tabindex="-1"></a>  l0 <span class="ot">&lt;-</span> cost_par[<span class="dv">13</span>]</span>
<span id="cb16-46"><a href="estimation.html#cb16-46" aria-hidden="true" tabindex="-1"></a>  a_l <span class="ot">&lt;-</span> cost_par[<span class="dv">14</span>]</span>
<span id="cb16-47"><a href="estimation.html#cb16-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-48"><a href="estimation.html#cb16-48" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Lambda</span></span>
<span id="cb16-49"><a href="estimation.html#cb16-49" aria-hidden="true" tabindex="-1"></a>  lambda <span class="ot">&lt;-</span> lambda</span>
<span id="cb16-50"><a href="estimation.html#cb16-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-51"><a href="estimation.html#cb16-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Price</span></span>
<span id="cb16-52"><a href="estimation.html#cb16-52" aria-hidden="true" tabindex="-1"></a>  price <span class="ot">&lt;-</span> df<span class="sc">$</span>price <span class="sc">*</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">dim</span>(df)[<span class="dv">1</span>] <span class="sc">*</span> R), <span class="at">nrow =</span> <span class="fu">dim</span>(df)[<span class="dv">1</span>])</span>
<span id="cb16-53"><a href="estimation.html#cb16-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(price) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">paste</span>(<span class="st">&quot;price&quot;</span>, <span class="dv">1</span><span class="sc">:</span>R, <span class="at">sep =</span> <span class="st">&quot;_&quot;</span>))</span>
<span id="cb16-54"><a href="estimation.html#cb16-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-55"><a href="estimation.html#cb16-55" aria-hidden="true" tabindex="-1"></a>  price <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(price) <span class="sc">%&gt;%</span> </span>
<span id="cb16-56"><a href="estimation.html#cb16-56" aria-hidden="true" tabindex="-1"></a>    tibble<span class="sc">::</span><span class="fu">as_tibble</span>()  </span>
<span id="cb16-57"><a href="estimation.html#cb16-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-58"><a href="estimation.html#cb16-58" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate Demand Friction</span></span>
<span id="cb16-59"><a href="estimation.html#cb16-59" aria-hidden="true" tabindex="-1"></a>  demand_friction <span class="ot">&lt;-</span> lambda <span class="sc">%&gt;%</span> </span>
<span id="cb16-60"><a href="estimation.html#cb16-60" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)),</span>
<span id="cb16-61"><a href="estimation.html#cb16-61" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">funs</span>(<span class="fu">ifelse</span>(d <span class="sc">==</span> prior_firm, </span>
<span id="cb16-62"><a href="estimation.html#cb16-62" aria-hidden="true" tabindex="-1"></a>                                 <span class="dv">0</span>,  </span>
<span id="cb16-63"><a href="estimation.html#cb16-63" aria-hidden="true" tabindex="-1"></a>                                 eta_f[<span class="dv">1</span>] <span class="sc">+</span> eta_f[<span class="dv">2</span>]<span class="sc">*</span>x_1 <span class="sc">+</span> eta_f[<span class="dv">3</span>]<span class="sc">*</span>x_2 <span class="sc">+</span> eta_f[<span class="dv">4</span>]<span class="sc">*</span>x_3) </span>
<span id="cb16-64"><a href="estimation.html#cb16-64" aria-hidden="true" tabindex="-1"></a>                          <span class="sc">+</span> <span class="fu">ifelse</span>(d <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> t <span class="sc">==</span> <span class="dv">0</span>, </span>
<span id="cb16-65"><a href="estimation.html#cb16-65" aria-hidden="true" tabindex="-1"></a>                                   xi[<span class="dv">1</span>] <span class="sc">+</span> xi[<span class="dv">2</span>]<span class="sc">*</span><span class="fu">log</span>(.), </span>
<span id="cb16-66"><a href="estimation.html#cb16-66" aria-hidden="true" tabindex="-1"></a>                                   <span class="dv">0</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb16-67"><a href="estimation.html#cb16-67" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;lambda&quot;</span>, <span class="st">&quot;demand_friction&quot;</span>), </span>
<span id="cb16-68"><a href="estimation.html#cb16-68" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb16-69"><a href="estimation.html#cb16-69" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">&quot;demand_friction&quot;</span>))</span>
<span id="cb16-70"><a href="estimation.html#cb16-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-71"><a href="estimation.html#cb16-71" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate E_score</span></span>
<span id="cb16-72"><a href="estimation.html#cb16-72" aria-hidden="true" tabindex="-1"></a>  E_score <span class="ot">&lt;-</span> lambda <span class="sc">%&gt;%</span> </span>
<span id="cb16-73"><a href="estimation.html#cb16-73" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)),</span>
<span id="cb16-74"><a href="estimation.html#cb16-74" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">funs</span>(<span class="fu">ifelse</span>(t <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> m <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb16-75"><a href="estimation.html#cb16-75" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">exp</span>(theta_score[<span class="dv">1</span>] <span class="sc">+</span> theta_score[<span class="dv">2</span>]<span class="sc">*</span><span class="fu">log</span>(.)</span>
<span id="cb16-76"><a href="estimation.html#cb16-76" aria-hidden="true" tabindex="-1"></a>                                     <span class="sc">+</span> theta_score[<span class="dv">3</span>]<span class="sc">*</span>x_1 <span class="sc">+</span> theta_score[<span class="dv">4</span>]<span class="sc">*</span>x_2</span>
<span id="cb16-77"><a href="estimation.html#cb16-77" aria-hidden="true" tabindex="-1"></a>                                     <span class="sc">+</span> sigma_score<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb16-78"><a href="estimation.html#cb16-78" aria-hidden="true" tabindex="-1"></a>                                 <span class="dv">0</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb16-79"><a href="estimation.html#cb16-79" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;lambda&quot;</span>, <span class="st">&quot;E_score&quot;</span>), </span>
<span id="cb16-80"><a href="estimation.html#cb16-80" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>))</span>
<span id="cb16-81"><a href="estimation.html#cb16-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-82"><a href="estimation.html#cb16-82" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate E_oop</span></span>
<span id="cb16-83"><a href="estimation.html#cb16-83" aria-hidden="true" tabindex="-1"></a>  E_oop <span class="ot">&lt;-</span> lambda <span class="sc">%&gt;%</span> </span>
<span id="cb16-84"><a href="estimation.html#cb16-84" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)),</span>
<span id="cb16-85"><a href="estimation.html#cb16-85" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">funs</span>(.<span class="sc">*</span><span class="fu">exp</span>(<span class="sc">-</span>.)<span class="sc">*</span>(l0<span class="sc">^</span>(a_l)<span class="sc">/</span>(a_l <span class="sc">-</span> <span class="dv">1</span>))<span class="sc">*</span>policy_limit<span class="sc">^</span>(<span class="sc">-</span>a_l <span class="sc">+</span> <span class="dv">1</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb16-86"><a href="estimation.html#cb16-86" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;lambda&quot;</span>, <span class="st">&quot;E_oop&quot;</span>), </span>
<span id="cb16-87"><a href="estimation.html#cb16-87" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb16-88"><a href="estimation.html#cb16-88" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">&quot;E_oop&quot;</span>))</span>
<span id="cb16-89"><a href="estimation.html#cb16-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-90"><a href="estimation.html#cb16-90" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate E_R_s</span></span>
<span id="cb16-91"><a href="estimation.html#cb16-91" aria-hidden="true" tabindex="-1"></a>  E_R_s <span class="ot">&lt;-</span> E_score <span class="sc">%&gt;%</span> </span>
<span id="cb16-92"><a href="estimation.html#cb16-92" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">&quot;E_score&quot;</span>)),</span>
<span id="cb16-93"><a href="estimation.html#cb16-93" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">funs</span>(<span class="fu">ifelse</span>(t <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> m <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb16-94"><a href="estimation.html#cb16-94" aria-hidden="true" tabindex="-1"></a>                                 (alpha_m1[<span class="dv">1</span>] <span class="sc">+</span> alpha_m1[<span class="dv">2</span>]<span class="sc">*</span>x_1 <span class="sc">+</span> alpha_m1[<span class="dv">3</span>]<span class="sc">*</span>x_2 <span class="sc">+</span> alpha_m1[<span class="dv">4</span>]<span class="sc">*</span>.) <span class="sc">/</span> beta,</span>
<span id="cb16-95"><a href="estimation.html#cb16-95" aria-hidden="true" tabindex="-1"></a>                                 (alpha_m0[<span class="dv">1</span>] <span class="sc">+</span> alpha_m0[<span class="dv">2</span>]<span class="sc">*</span>x_1 <span class="sc">+</span> alpha_m0[<span class="dv">3</span>]<span class="sc">*</span>x_2) <span class="sc">/</span> beta))) <span class="sc">%&gt;%</span> </span>
<span id="cb16-96"><a href="estimation.html#cb16-96" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;E_score&quot;</span>, <span class="st">&quot;E_R_s&quot;</span>), </span>
<span id="cb16-97"><a href="estimation.html#cb16-97" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;E_score&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb16-98"><a href="estimation.html#cb16-98" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">&quot;E_R_s&quot;</span>))</span>
<span id="cb16-99"><a href="estimation.html#cb16-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-100"><a href="estimation.html#cb16-100" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate E_R_C</span></span>
<span id="cb16-101"><a href="estimation.html#cb16-101" aria-hidden="true" tabindex="-1"></a>  E_R_C <span class="ot">&lt;-</span> lambda <span class="sc">%&gt;%</span> </span>
<span id="cb16-102"><a href="estimation.html#cb16-102" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)),</span>
<span id="cb16-103"><a href="estimation.html#cb16-103" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">funs</span>(<span class="fl">0.98</span> <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>.) <span class="sc">+</span> <span class="fl">1.2</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">exp</span>(<span class="sc">-</span>.)))) <span class="sc">%&gt;%</span> </span>
<span id="cb16-104"><a href="estimation.html#cb16-104" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;lambda&quot;</span>, <span class="st">&quot;E_R_C&quot;</span>), </span>
<span id="cb16-105"><a href="estimation.html#cb16-105" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;lambda&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb16-106"><a href="estimation.html#cb16-106" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">&quot;E_R_C&quot;</span>))</span>
<span id="cb16-107"><a href="estimation.html#cb16-107" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-108"><a href="estimation.html#cb16-108" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate E_h</span></span>
<span id="cb16-109"><a href="estimation.html#cb16-109" aria-hidden="true" tabindex="-1"></a>  E_h <span class="ot">&lt;-</span> <span class="sc">-</span> price <span class="sc">-</span> demand_friction <span class="sc">-</span> E_oop <span class="sc">-</span> E_R_s <span class="sc">*</span> E_R_C <span class="sc">*</span> price</span>
<span id="cb16-110"><a href="estimation.html#cb16-110" aria-hidden="true" tabindex="-1"></a>  E_h <span class="ot">&lt;-</span> E_h <span class="sc">%&gt;%</span> </span>
<span id="cb16-111"><a href="estimation.html#cb16-111" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;price&quot;</span>, <span class="st">&quot;E_h&quot;</span>), </span>
<span id="cb16-112"><a href="estimation.html#cb16-112" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;price&quot;</span>))</span>
<span id="cb16-113"><a href="estimation.html#cb16-113" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-114"><a href="estimation.html#cb16-114" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate v</span></span>
<span id="cb16-115"><a href="estimation.html#cb16-115" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Note that now we ignore the second term of v and thus v = E_h</span></span>
<span id="cb16-116"><a href="estimation.html#cb16-116" aria-hidden="true" tabindex="-1"></a>  v <span class="ot">&lt;-</span> E_h  <span class="sc">%&gt;%</span> </span>
<span id="cb16-117"><a href="estimation.html#cb16-117" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;E_h&quot;</span>, <span class="st">&quot;v&quot;</span>), </span>
<span id="cb16-118"><a href="estimation.html#cb16-118" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;E_h&quot;</span>))</span>
<span id="cb16-119"><a href="estimation.html#cb16-119" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-120"><a href="estimation.html#cb16-120" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Calculate Choice Probability</span></span>
<span id="cb16-121"><a href="estimation.html#cb16-121" aria-hidden="true" tabindex="-1"></a>  choice_probability <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb16-122"><a href="estimation.html#cb16-122" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(v) <span class="sc">%&gt;%</span> </span>
<span id="cb16-123"><a href="estimation.html#cb16-123" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">group_by</span>(i, t) <span class="sc">%&gt;%</span> </span>
<span id="cb16-124"><a href="estimation.html#cb16-124" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">&quot;v&quot;</span>)),</span>
<span id="cb16-125"><a href="estimation.html#cb16-125" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">funs</span>(<span class="fu">exp</span>(.) <span class="sc">/</span> <span class="fu">sum</span>(<span class="fu">exp</span>(.)))) <span class="sc">%&gt;%</span> </span>
<span id="cb16-126"><a href="estimation.html#cb16-126" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb16-127"><a href="estimation.html#cb16-127" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(\(x) <span class="fu">str_replace</span>(x, <span class="st">&quot;v&quot;</span>, <span class="st">&quot;choice_probability&quot;</span>), </span>
<span id="cb16-128"><a href="estimation.html#cb16-128" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">starts_with</span>(<span class="st">&quot;v&quot;</span>))</span>
<span id="cb16-129"><a href="estimation.html#cb16-129" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-130"><a href="estimation.html#cb16-130" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Calculate Log-likelihood</span></span>
<span id="cb16-131"><a href="estimation.html#cb16-131" aria-hidden="true" tabindex="-1"></a>  LL_choice <span class="ot">&lt;-</span> choice_probability <span class="sc">%&gt;%</span> </span>
<span id="cb16-132"><a href="estimation.html#cb16-132" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">&quot;choice_probability&quot;</span>)),</span>
<span id="cb16-133"><a href="estimation.html#cb16-133" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">funs</span>(choice <span class="sc">*</span> <span class="fu">log</span>(.))) <span class="sc">%&gt;%</span> </span>
<span id="cb16-134"><a href="estimation.html#cb16-134" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">summarise_at</span>(<span class="fu">vars</span>(<span class="fu">starts_with</span>(<span class="st">&quot;choice_probability&quot;</span>)),</span>
<span id="cb16-135"><a href="estimation.html#cb16-135" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">funs</span>(<span class="fu">sum</span>(.)))</span>
<span id="cb16-136"><a href="estimation.html#cb16-136" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-137"><a href="estimation.html#cb16-137" aria-hidden="true" tabindex="-1"></a>  LL_choice <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(LL_choice) <span class="sc">%&gt;%</span> </span>
<span id="cb16-138"><a href="estimation.html#cb16-138" aria-hidden="true" tabindex="-1"></a>    <span class="fu">apply</span>(<span class="dv">1</span>, mean)</span>
<span id="cb16-139"><a href="estimation.html#cb16-139" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-140"><a href="estimation.html#cb16-140" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Output</span></span>
<span id="cb16-141"><a href="estimation.html#cb16-141" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> LL_choice</span>
<span id="cb16-142"><a href="estimation.html#cb16-142" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-143"><a href="estimation.html#cb16-143" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(output)</span>
<span id="cb16-144"><a href="estimation.html#cb16-144" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-145"><a href="estimation.html#cb16-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-146"><a href="estimation.html#cb16-146" aria-hidden="true" tabindex="-1"></a><span class="co"># Log-likelihood for Renewal Price</span></span>
<span id="cb16-147"><a href="estimation.html#cb16-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-148"><a href="estimation.html#cb16-148" aria-hidden="true" tabindex="-1"></a>LL_renewal_price <span class="ot">&lt;-</span> <span class="cf">function</span>(df, theta, cost_par, lambda){</span>
<span id="cb16-149"><a href="estimation.html#cb16-149" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Parameters</span></span>
<span id="cb16-150"><a href="estimation.html#cb16-150" aria-hidden="true" tabindex="-1"></a>  alpha_m0 <span class="ot">&lt;-</span> theta[<span class="dv">7</span><span class="sc">:</span><span class="dv">9</span>]</span>
<span id="cb16-151"><a href="estimation.html#cb16-151" aria-hidden="true" tabindex="-1"></a>  alpha_m1 <span class="ot">&lt;-</span> theta[<span class="dv">10</span><span class="sc">:</span><span class="dv">13</span>]</span>
<span id="cb16-152"><a href="estimation.html#cb16-152" aria-hidden="true" tabindex="-1"></a>  beta <span class="ot">&lt;-</span> theta[<span class="dv">14</span>]</span>
<span id="cb16-153"><a href="estimation.html#cb16-153" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-154"><a href="estimation.html#cb16-154" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate log-likelihood of R_s</span></span>
<span id="cb16-155"><a href="estimation.html#cb16-155" aria-hidden="true" tabindex="-1"></a>  <span class="do">## In the paper, we assume away uncertainty in s</span></span>
<span id="cb16-156"><a href="estimation.html#cb16-156" aria-hidden="true" tabindex="-1"></a>  R_s <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb16-157"><a href="estimation.html#cb16-157" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(t <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb16-158"><a href="estimation.html#cb16-158" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">gamma_alpha =</span> <span class="fu">ifelse</span>(score <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb16-159"><a href="estimation.html#cb16-159" aria-hidden="true" tabindex="-1"></a>                                       alpha_m0[<span class="dv">1</span>] <span class="sc">+</span> alpha_m0[<span class="dv">2</span>]<span class="sc">*</span>x_1 <span class="sc">+</span> alpha_m0[<span class="dv">3</span>]<span class="sc">*</span>x_2,</span>
<span id="cb16-160"><a href="estimation.html#cb16-160" aria-hidden="true" tabindex="-1"></a>                                       alpha_m1[<span class="dv">1</span>] <span class="sc">+</span> alpha_m1[<span class="dv">2</span>]<span class="sc">*</span>x_1 <span class="sc">+</span> alpha_m1[<span class="dv">3</span>]<span class="sc">*</span>x_2 <span class="sc">+</span> alpha_m1[<span class="dv">4</span>]<span class="sc">*</span>score),</span>
<span id="cb16-161"><a href="estimation.html#cb16-161" aria-hidden="true" tabindex="-1"></a>                  <span class="at">LL_gamma =</span> <span class="fu">log</span>(((beta<span class="sc">^</span>gamma_alpha)<span class="sc">/</span><span class="fu">gamma</span>(gamma_alpha)) <span class="sc">*</span> R_s<span class="sc">^</span>(gamma_alpha <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>beta <span class="sc">*</span> R_s)))</span>
<span id="cb16-162"><a href="estimation.html#cb16-162" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-163"><a href="estimation.html#cb16-163" aria-hidden="true" tabindex="-1"></a>  LL_R_s <span class="ot">&lt;-</span> <span class="fu">sum</span>(R_s<span class="sc">$</span>LL_gamma)</span>
<span id="cb16-164"><a href="estimation.html#cb16-164" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-165"><a href="estimation.html#cb16-165" aria-hidden="true" tabindex="-1"></a>  <span class="do">## 作ったが、Choice Modelの推定においては不要</span></span>
<span id="cb16-166"><a href="estimation.html#cb16-166" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate log-likelihood of R_C</span></span>
<span id="cb16-167"><a href="estimation.html#cb16-167" aria-hidden="true" tabindex="-1"></a>  <span class="do">## We first match lambda in t = 0, since claim surcharge is resulted from lambda in t = 0</span></span>
<span id="cb16-168"><a href="estimation.html#cb16-168" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-169"><a href="estimation.html#cb16-169" aria-hidden="true" tabindex="-1"></a>  <span class="co"># lambda_t0 &lt;- lambda %&gt;% </span></span>
<span id="cb16-170"><a href="estimation.html#cb16-170" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   dplyr::filter(t == 0, f == 1) %&gt;% </span></span>
<span id="cb16-171"><a href="estimation.html#cb16-171" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   dplyr::select(i, m, matches(&quot;lambda&quot;))</span></span>
<span id="cb16-172"><a href="estimation.html#cb16-172" aria-hidden="true" tabindex="-1"></a>  <span class="co"># </span></span>
<span id="cb16-173"><a href="estimation.html#cb16-173" aria-hidden="true" tabindex="-1"></a>  <span class="co"># R_C &lt;- df %&gt;% </span></span>
<span id="cb16-174"><a href="estimation.html#cb16-174" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   dplyr::filter(t == 1) %&gt;% </span></span>
<span id="cb16-175"><a href="estimation.html#cb16-175" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   dplyr::mutate(m = ifelse(score == 1, 0, 1)) %&gt;% </span></span>
<span id="cb16-176"><a href="estimation.html#cb16-176" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   dplyr::left_join(lambda_t0, by = c(&quot;i&quot;, &quot;m&quot;)) %&gt;% </span></span>
<span id="cb16-177"><a href="estimation.html#cb16-177" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   dplyr::mutate_at(vars(starts_with(&quot;lambda&quot;)),</span></span>
<span id="cb16-178"><a href="estimation.html#cb16-178" aria-hidden="true" tabindex="-1"></a>  <span class="co">#                    funs((exp(-.)^(R_C == 0.98)) * (1 - exp(-.)^(R_C == 1.2)))) %&gt;% </span></span>
<span id="cb16-179"><a href="estimation.html#cb16-179" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   dplyr::rename_with(\(x) str_replace(x, &quot;lambda&quot;, &quot;LL_surcharge&quot;), </span></span>
<span id="cb16-180"><a href="estimation.html#cb16-180" aria-hidden="true" tabindex="-1"></a>  <span class="co">#                      starts_with(&quot;lambda&quot;)) %&gt;% </span></span>
<span id="cb16-181"><a href="estimation.html#cb16-181" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   dplyr::summarise_at(vars(starts_with(&quot;LL_surcharge&quot;)),</span></span>
<span id="cb16-182"><a href="estimation.html#cb16-182" aria-hidden="true" tabindex="-1"></a>  <span class="co">#                       funs(sum(.)))</span></span>
<span id="cb16-183"><a href="estimation.html#cb16-183" aria-hidden="true" tabindex="-1"></a>  <span class="co"># </span></span>
<span id="cb16-184"><a href="estimation.html#cb16-184" aria-hidden="true" tabindex="-1"></a>  <span class="co"># LL_R_C &lt;- as.matrix(R_C) %&gt;% </span></span>
<span id="cb16-185"><a href="estimation.html#cb16-185" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   apply(1, mean)</span></span>
<span id="cb16-186"><a href="estimation.html#cb16-186" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-187"><a href="estimation.html#cb16-187" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> LL_R_s</span>
<span id="cb16-188"><a href="estimation.html#cb16-188" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-189"><a href="estimation.html#cb16-189" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(output)</span>
<span id="cb16-190"><a href="estimation.html#cb16-190" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-191"><a href="estimation.html#cb16-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-192"><a href="estimation.html#cb16-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-193"><a href="estimation.html#cb16-193" aria-hidden="true" tabindex="-1"></a><span class="do">## Simulated Log-likelihood</span></span>
<span id="cb16-194"><a href="estimation.html#cb16-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-195"><a href="estimation.html#cb16-195" aria-hidden="true" tabindex="-1"></a>SLL <span class="ot">&lt;-</span> <span class="cf">function</span>(df, theta, cost_par, lambda){</span>
<span id="cb16-196"><a href="estimation.html#cb16-196" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Choice Probability</span></span>
<span id="cb16-197"><a href="estimation.html#cb16-197" aria-hidden="true" tabindex="-1"></a>  LL_choice <span class="ot">&lt;-</span> <span class="fu">LL_choice</span>(df, theta, cost_par, lambda)</span>
<span id="cb16-198"><a href="estimation.html#cb16-198" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-199"><a href="estimation.html#cb16-199" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Renewal Price</span></span>
<span id="cb16-200"><a href="estimation.html#cb16-200" aria-hidden="true" tabindex="-1"></a>  LL_renewal_price <span class="ot">&lt;-</span> <span class="fu">LL_renewal_price</span>(df, theta, cost_par, lambda)</span>
<span id="cb16-201"><a href="estimation.html#cb16-201" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-202"><a href="estimation.html#cb16-202" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Output</span></span>
<span id="cb16-203"><a href="estimation.html#cb16-203" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> (<span class="sc">-</span><span class="dv">1</span>) <span class="sc">*</span> (LL_choice <span class="sc">+</span> LL_renewal_price)</span>
<span id="cb16-204"><a href="estimation.html#cb16-204" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(output)</span></span>
<span id="cb16-205"><a href="estimation.html#cb16-205" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-206"><a href="estimation.html#cb16-206" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(output)</span>
<span id="cb16-207"><a href="estimation.html#cb16-207" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="optimization" class="section level2 hasAnchor" number="2.2">
<h2><span class="header-section-number">2.2</span> Optimization<a href="estimation.html#optimization" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="estimation.html#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cost Parameters</span></span>
<span id="cb17-2"><a href="estimation.html#cb17-2" aria-hidden="true" tabindex="-1"></a>cost_par <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb17-3"><a href="estimation.html#cb17-3" aria-hidden="true" tabindex="-1"></a>cost_par[<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>] <span class="ot">&lt;-</span> theta_lambda</span>
<span id="cb17-4"><a href="estimation.html#cb17-4" aria-hidden="true" tabindex="-1"></a>cost_par[<span class="dv">7</span>] <span class="ot">&lt;-</span> sigma_lambda</span>
<span id="cb17-5"><a href="estimation.html#cb17-5" aria-hidden="true" tabindex="-1"></a>cost_par[<span class="dv">8</span><span class="sc">:</span><span class="dv">11</span>] <span class="ot">&lt;-</span> theta_score</span>
<span id="cb17-6"><a href="estimation.html#cb17-6" aria-hidden="true" tabindex="-1"></a>cost_par[<span class="dv">12</span>] <span class="ot">&lt;-</span> sigma_score</span>
<span id="cb17-7"><a href="estimation.html#cb17-7" aria-hidden="true" tabindex="-1"></a>cost_par[<span class="dv">13</span>] <span class="ot">&lt;-</span> l0</span>
<span id="cb17-8"><a href="estimation.html#cb17-8" aria-hidden="true" tabindex="-1"></a>cost_par[<span class="dv">14</span>] <span class="ot">&lt;-</span> a_l</span>
<span id="cb17-9"><a href="estimation.html#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="estimation.html#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Choice Parameters</span></span>
<span id="cb17-11"><a href="estimation.html#cb17-11" aria-hidden="true" tabindex="-1"></a>theta <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb17-12"><a href="estimation.html#cb17-12" aria-hidden="true" tabindex="-1"></a>theta[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>] <span class="ot">&lt;-</span> eta_f</span>
<span id="cb17-13"><a href="estimation.html#cb17-13" aria-hidden="true" tabindex="-1"></a>theta[<span class="dv">5</span><span class="sc">:</span><span class="dv">6</span>] <span class="ot">&lt;-</span> xi</span>
<span id="cb17-14"><a href="estimation.html#cb17-14" aria-hidden="true" tabindex="-1"></a>theta[<span class="dv">7</span><span class="sc">:</span><span class="dv">9</span>] <span class="ot">&lt;-</span> alpha_m0</span>
<span id="cb17-15"><a href="estimation.html#cb17-15" aria-hidden="true" tabindex="-1"></a>theta[<span class="dv">10</span><span class="sc">:</span><span class="dv">13</span>] <span class="ot">&lt;-</span> alpha_m1</span>
<span id="cb17-16"><a href="estimation.html#cb17-16" aria-hidden="true" tabindex="-1"></a>theta[<span class="dv">14</span>] <span class="ot">&lt;-</span> beta</span>
<span id="cb17-17"><a href="estimation.html#cb17-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-18"><a href="estimation.html#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate lambda</span></span>
<span id="cb17-19"><a href="estimation.html#cb17-19" aria-hidden="true" tabindex="-1"></a>R <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb17-20"><a href="estimation.html#cb17-20" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="fu">gen_lambda</span>(df, cost_par, R)</span>
<span id="cb17-21"><a href="estimation.html#cb17-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-22"><a href="estimation.html#cb17-22" aria-hidden="true" tabindex="-1"></a><span class="do">## Initial Value</span></span>
<span id="cb17-23"><a href="estimation.html#cb17-23" aria-hidden="true" tabindex="-1"></a>x0 <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(theta))</span>
<span id="cb17-24"><a href="estimation.html#cb17-24" aria-hidden="true" tabindex="-1"></a>x0[<span class="dv">7</span>] <span class="ot">&lt;-</span> <span class="dv">25</span></span>
<span id="cb17-25"><a href="estimation.html#cb17-25" aria-hidden="true" tabindex="-1"></a>x0[<span class="dv">10</span>] <span class="ot">&lt;-</span> <span class="dv">25</span></span>
<span id="cb17-26"><a href="estimation.html#cb17-26" aria-hidden="true" tabindex="-1"></a>x0[<span class="dv">14</span>] <span class="ot">&lt;-</span> <span class="dv">25</span></span>
<span id="cb17-27"><a href="estimation.html#cb17-27" aria-hidden="true" tabindex="-1"></a><span class="co"># x0 &lt;- theta * 0.8</span></span>
<span id="cb17-28"><a href="estimation.html#cb17-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-29"><a href="estimation.html#cb17-29" aria-hidden="true" tabindex="-1"></a><span class="do">## Optimization</span></span>
<span id="cb17-30"><a href="estimation.html#cb17-30" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">optim</span>(<span class="at">par =</span> x0,</span>
<span id="cb17-31"><a href="estimation.html#cb17-31" aria-hidden="true" tabindex="-1"></a>             <span class="at">fn =</span> SLL, </span>
<span id="cb17-32"><a href="estimation.html#cb17-32" aria-hidden="true" tabindex="-1"></a>             <span class="at">method =</span> <span class="st">&quot;Nelder-Mead&quot;</span>,</span>
<span id="cb17-33"><a href="estimation.html#cb17-33" aria-hidden="true" tabindex="-1"></a>             <span class="at">df =</span> df, </span>
<span id="cb17-34"><a href="estimation.html#cb17-34" aria-hidden="true" tabindex="-1"></a>             <span class="at">cost_par =</span> cost_par, </span>
<span id="cb17-35"><a href="estimation.html#cb17-35" aria-hidden="true" tabindex="-1"></a>             <span class="at">lambda =</span> lambda)</span>
<span id="cb17-36"><a href="estimation.html#cb17-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-37"><a href="estimation.html#cb17-37" aria-hidden="true" tabindex="-1"></a>theta_est <span class="ot">&lt;-</span> res<span class="sc">$</span>par</span></code></pre></div>
</div>
<div id="estimation-results" class="section level2 hasAnchor" number="2.3">
<h2><span class="header-section-number">2.3</span> Estimation Results<a href="estimation.html#estimation-results" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="estimation.html#cb18-1" aria-hidden="true" tabindex="-1"></a>table <span class="ot">&lt;-</span> <span class="fu">cbind</span>(theta, theta_est)</span>
<span id="cb18-2"><a href="estimation.html#cb18-2" aria-hidden="true" tabindex="-1"></a>table <span class="ot">&lt;-</span> <span class="fu">format</span>(<span class="fu">round</span>(table, <span class="dv">2</span>), <span class="dv">2</span>)</span>
<span id="cb18-3"><a href="estimation.html#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(table) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;true&quot;</span>, <span class="st">&quot;estimates&quot;</span>)</span>
<span id="cb18-4"><a href="estimation.html#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(table) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;eta_f&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="st">&quot;&quot;</span>, </span>
<span id="cb18-5"><a href="estimation.html#cb18-5" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot;xi&quot;</span>, <span class="st">&quot;&quot;</span>, </span>
<span id="cb18-6"><a href="estimation.html#cb18-6" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot;alpha_m0&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="st">&quot;&quot;</span>, </span>
<span id="cb18-7"><a href="estimation.html#cb18-7" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot;alpha_m1&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="st">&quot;&quot;</span>, </span>
<span id="cb18-8"><a href="estimation.html#cb18-8" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot;beta&quot;</span>)</span>
<span id="cb18-9"><a href="estimation.html#cb18-9" aria-hidden="true" tabindex="-1"></a>table</span></code></pre></div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="generate-data.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": false,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
